<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ»ç”Ÿç•Œé¢ - åŒ»é™¢æŒ‚å·ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/booking-style.css">
    <link rel="stylesheet" href="assets/responsive.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- æ¶ˆæ¯æç¤º -->
    <div id="message" class="alert" style="display: none;"></div>

    <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>

    <!-- ä¾§è¾¹æ é®ç½©å±‚ -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="admin-layout">
        <!-- ä¾§è¾¹æ å¯¼èˆª -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>åŒ»é™¢æŒ‚å·ç³»ç»Ÿ</h2>
                <p class="sidebar-subtitle">åŒ»ç”Ÿç«¯</p>
            </div>
            
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" onclick="showSection('dashboard')">
                    <span class="nav-icon">ğŸ“Š</span>
                    <span class="nav-text">ç³»ç»Ÿæ¦‚è§ˆ</span>
                </a>
                <a href="#" class="nav-item" onclick="showSection('schedule')">
                    <span class="nav-icon">ğŸ“…</span>
                    <span class="nav-text">æ’ç­æ—¥ç¨‹</span>
                </a>
                <a href="#" class="nav-item" onclick="showSection('patients')">
                    <span class="nav-icon">ğŸ‘¥</span>
                    <span class="nav-text">æ‚£è€…ç®¡ç†</span>
                </a>
                <a href="#" class="nav-item" onclick="showSection('profile')">
                    <span class="nav-icon">âš™ï¸</span>
                    <span class="nav-text">ä¸ªäººä¿¡æ¯</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <span class="user-icon">ğŸ‘¨â€âš•ï¸</span>
                    <div class="user-details">
                        <div class="user-name" id="username"></div>
                        <div class="user-role">åŒ»ç”Ÿ</div>
                    </div>
                </div>
                
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </aside>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <!-- ç³»ç»Ÿæ¦‚è§ˆ -->
            <div id="section-dashboard" class="content-section active">
                <!-- ä¸ªäººç»Ÿè®¡ -->
                <div class="card">
                    <h2>ä¸ªäººç»Ÿè®¡</h2>
                    <div class="grid grid-4">
                        <div class="stats-card">
                            <h3 id="totalMyPatients">0</h3>
                            <p>æ€»æ‚£è€…æ•°</p>
                        </div>
                        <div class="stats-card">
                            <h3 id="totalMyRegistrations">0</h3>
                            <p>æ€»æŒ‚å·æ•°</p>
                        </div>
                        <div class="stats-card">
                            <h3 id="myActiveRegistrations">0</h3>
                            <p>å¾…å°±è¯Š</p>
                        </div>
                        <div class="stats-card">
                            <h3 id="myCompletedRegistrations">0</h3>
                            <p>å·²å®Œæˆ</p>
                        </div>
                    </div>
                </div>

                <!-- æŒ‚å·è¶‹åŠ¿ -->
                <div class="card" style="flex: 1; display: flex; flex-direction: column;">
                    <h2>æˆ‘çš„æŒ‚å·è¶‹åŠ¿ï¼ˆæœ€è¿‘30å¤©ï¼‰</h2>
                    <div class="chart-container" style="flex: 1; min-height: 400px; position: relative;">
                        <canvas id="myTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- æ’ç­æ—¥ç¨‹ -->
            <div id="section-schedule" class="content-section">
                <div class="card">
                    <h2>æˆ‘çš„æ’ç­æ—¥ç¨‹</h2>
                    
                    <div class="schedule-table-container">
                        <table class="schedule-table">
                            <thead>
                                <tr>
                                    <th>æ—¶æ®µ</th>
                                    <th>å‘¨ä¸€</th>
                                    <th>å‘¨äºŒ</th>
                                    <th>å‘¨ä¸‰</th>
                                    <th>å‘¨å››</th>
                                    <th>å‘¨äº”</th>
                                    <th>å‘¨å…­</th>
                                    <th>å‘¨æ—¥</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>ä¸Šåˆ</strong><br><small>08:00-12:00</small></td>
                                    <td id="monday_am"></td>
                                    <td id="tuesday_am"></td>
                                    <td id="wednesday_am"></td>
                                    <td id="thursday_am"></td>
                                    <td id="friday_am"></td>
                                    <td id="saturday_am"></td>
                                    <td id="sunday_am"></td>
                                </tr>
                                <tr>
                                    <td><strong>ä¸‹åˆ</strong><br><small>14:00-18:00</small></td>
                                    <td id="monday_pm"></td>
                                    <td id="tuesday_pm"></td>
                                    <td id="wednesday_pm"></td>
                                    <td id="thursday_pm"></td>
                                    <td id="friday_pm"></td>
                                    <td id="saturday_pm"></td>
                                    <td id="sunday_pm"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="schedule-legend">
                        <div class="legend-item">
                            <div class="legend-box available"></div>
                            <span>ä¸Šç­</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box unavailable"></div>
                            <span>ä¼‘æ¯</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ‚£è€…ç®¡ç† -->
            <div id="section-patients" class="content-section">
                <!-- æœç´¢æ‚£è€… -->
                <div class="card">
            <h2>æœç´¢æ‚£è€…</h2>
            <div class="grid grid-3">
                <div class="form-group">
                    <label for="searchName">æ‚£è€…å§“å</label>
                    <input type="text" id="searchName" class="form-control" placeholder="è¾“å…¥æ‚£è€…å§“å">
                </div>
                <div class="form-group">
                    <label for="searchPhone">æ‰‹æœºå·ç </label>
                    <input type="text" id="searchPhone" class="form-control" placeholder="è¾“å…¥æ‰‹æœºå·ç ">
                </div>
                <div class="form-group">
                    <label for="searchRegId">æŒ‚å·ID</label>
                    <input type="text" id="searchRegId" class="form-control" placeholder="è¾“å…¥æŒ‚å·ID">
                </div>
            </div>
                    <button class="btn btn-primary" onclick="searchPatients()">æœç´¢</button>
                    <button class="btn btn-secondary" onclick="clearSearch()">æ¸…ç©º</button>
                </div>

                <!-- æ‚£è€…åˆ—è¡¨ -->
                <div class="card">
            <div class="flex justify-between align-center mb-2">
                <h2>æ‚£è€…åˆ—è¡¨</h2>
                <div>
                    <button class="btn btn-secondary btn-sm" onclick="filterByTime('active')" id="filterActive">å¾…å°±è¯Š</button>
                    <button class="btn btn-secondary btn-sm" onclick="filterByTime('completed')" id="filterCompleted">å†å²è®°å½•</button>
                    <button class="btn btn-secondary btn-sm" onclick="filterByTime('today')" id="filterToday">ä»Šå¤©</button>
                    <button class="btn btn-secondary btn-sm" onclick="filterByTime('all')" id="filterAll">å…¨éƒ¨</button>
                </div>
            </div>
            
            <div class="loading" id="patientsLoading">
                <div class="spinner"></div>
            </div>
            
            <div id="patientsContainer" style="display: none;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>æŒ‚å·ID</th>
                            <th>æ‚£è€…å§“å</th>
                            <th>è”ç³»ç”µè¯</th>
                            <th>é¢„çº¦æ—¶é—´</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="patientsTable">
                    </tbody>
                </table>
                <div id="noPatients" style="display: none; text-align: center; padding: 2rem; color: #666;">
                    æš‚æ— æ‚£è€…è®°å½•
                </div>
                </div>
                </div>
            </div>

            <!-- ä¸ªäººä¿¡æ¯ -->
            <div id="section-profile" class="content-section">
                <div class="card" style="max-width: 800px; margin: 0 auto;">
                    <h2>ä¸ªäººä¿¡æ¯</h2>
                    
                    <!-- ç…§ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                    <div style="text-align: center; margin-bottom: 2rem; padding: 2rem; background: #f8f9fa; border-radius: 8px;">
                        <div style="margin-bottom: 1rem;">
                            <img id="doctorPhotoPreview" src="" alt="åŒ»ç”Ÿç…§ç‰‡" style="width: 180px; height: 240px; border-radius: 8px; object-fit: contain; border: 2px solid #e0e0e0; box-shadow: 0 4px 8px rgba(0,0,0,0.1); background: white;">
                        </div>
                        <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="previewPhoto(event)">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('photoInput').click()">é€‰æ‹©ç…§ç‰‡</button>
                        <button type="button" class="btn btn-primary" onclick="uploadPhoto()" id="uploadPhotoBtn" style="display: none;">ä¸Šä¼ ç…§ç‰‡</button>
                        <p style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
                            <strong>è¦æ±‚ï¼š</strong><br>
                            â€¢ æ ¼å¼ï¼šJPGã€PNGã€GIF<br>
                            â€¢ æ¯”ä¾‹ï¼š3:4ï¼ˆç«–ç‰ˆï¼‰<br>
                            â€¢ å°ºå¯¸ï¼š300Ã—400 è‡³ 2000Ã—2667 åƒç´ <br>
                            â€¢ æ¨èï¼š600Ã—800 æˆ– 900Ã—1200 åƒç´ <br>
                            â€¢ å¤§å°ï¼šä¸è¶…è¿‡ 2MB
                        </p>
                    </div>
                    
                    <form id="profileForm" onsubmit="updateProfile(event)">
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label for="profileName">å§“å *</label>
                                <input type="text" id="profileName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="profileTitle">èŒç§°</label>
                                <input type="text" id="profileTitle" class="form-control" readonly style="background-color: #f5f5f5;">
                                <small class="text-muted">èŒç§°ç”±ç®¡ç†å‘˜ç»Ÿä¸€ç®¡ç†</small>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="profileDept">æ‰€å±ç§‘å®¤</label>
                            <input type="text" id="profileDept" class="form-control" readonly style="background-color: #f5f5f5;">
                        </div>
                        
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label for="profilePassword">æ–°å¯†ç ï¼ˆç•™ç©ºåˆ™ä¸ä¿®æ”¹ï¼‰</label>
                                <input type="password" id="profilePassword" class="form-control" placeholder="å¦‚éœ€ä¿®æ”¹å¯†ç è¯·è¾“å…¥æ–°å¯†ç ">
                            </div>
                            <div class="form-group">
                                <label for="profilePasswordConfirm">ç¡®è®¤æ–°å¯†ç </label>
                                <input type="password" id="profilePasswordConfirm" class="form-control" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">ä¿å­˜ä¿®æ”¹</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- æ‚£è€…è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="patientModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ‚£è€…è¯¦æƒ…</h3>
                <span class="close" onclick="closePatientModal()">&times;</span>
            </div>
            <div id="patientDetails"></div>
            <div style="text-align: right; margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="closePatientModal()">å…³é—­</button>
                <button class="btn btn-success" id="completeBtn" onclick="markCompleted()">æ ‡è®°å·²å°±è¯Š</button>
            </div>
        </div>
    </div>

    <script src="assets/config.js"></script>
    <script>
        let allRegistrations = [];
        let filteredRegistrations = [];
        let currentFilter = 'all';
        let currentPatientId = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            if (!localStorage.getItem('token') || localStorage.getItem('role') !== 'doctor') {
                window.location.href = 'login.html';
                return;
            }

            // Set username
            document.getElementById('username').textContent = localStorage.getItem('username');

            // Load initial data
            loadDoctorStats();
            loadDoctorTrend();
            loadPatients();

            // Set up search event listeners
            document.getElementById('searchName').addEventListener('input', debounce(searchPatients, 500));
            document.getElementById('searchPhone').addEventListener('input', debounce(searchPatients, 500));
            document.getElementById('searchRegId').addEventListener('input', debounce(searchPatients, 500));
        });

        function showSection(sectionName) {
            // éšè—æ‰€æœ‰å†…å®¹åŒºåŸŸ
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰å¯¼èˆªé¡¹çš„activeç±»
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„å†…å®¹åŒºåŸŸ
            document.getElementById(`section-${sectionName}`).classList.add('active');
            
            // é«˜äº®é€‰ä¸­çš„å¯¼èˆªé¡¹
            event.target.closest('.nav-item').classList.add('active');
            
            // åŠ è½½å¯¹åº”æ•°æ®
            if (sectionName === 'dashboard') {
                loadDoctorStats();
                loadDoctorTrend();
            } else if (sectionName === 'schedule') {
                loadDoctorSchedule();
            } else if (sectionName === 'patients') {
                loadPatients();
            } else if (sectionName === 'profile') {
                loadProfile();
            }
        }

        async function loadDoctorSchedule() {
            try {
                const response = await apiRequest('/doctor/schedule');
                const schedule = response.schedule || {};
                
                // æ‰€æœ‰æ—¶æ®µ
                const slots = [
                    'monday_am', 'monday_pm',
                    'tuesday_am', 'tuesday_pm',
                    'wednesday_am', 'wednesday_pm',
                    'thursday_am', 'thursday_pm',
                    'friday_am', 'friday_pm',
                    'saturday_am', 'saturday_pm',
                    'sunday_am', 'sunday_pm'
                ];
                
                // å¡«å……æ’ç­è¡¨
                slots.forEach(slot => {
                    const cell = document.getElementById(slot);
                    if (cell) {
                        const isAvailable = schedule[slot] === true;
                        cell.innerHTML = `<span class="schedule-slot ${isAvailable ? 'available' : 'unavailable'}">${isAvailable ? 'ä¸Šç­' : 'ä¼‘æ¯'}</span>`;
                    }
                });
            } catch (error) {
                showMessage('åŠ è½½æ’ç­ä¿¡æ¯å¤±è´¥: ' + error.message, 'danger');
            }
        }

        async function loadPatients() {
            const loading = document.getElementById('patientsLoading');
            const container = document.getElementById('patientsContainer');
            
            loading.style.display = 'flex';
            container.style.display = 'none';

            try {
                allRegistrations = await apiRequest('/doctor/registrations');
                filteredRegistrations = [...allRegistrations];
                
                displayPatients();
                container.style.display = 'block';
            } catch (error) {
                showMessage('åŠ è½½æ‚£è€…æ•°æ®å¤±è´¥: ' + error.message, 'danger');
            } finally {
                loading.style.display = 'none';
            }
        }

        async function searchPatients() {
            const name = document.getElementById('searchName').value.trim();
            const phone = document.getElementById('searchPhone').value.trim();
            const regId = document.getElementById('searchRegId').value.trim();

            if (!name && !phone && !regId) {
                filteredRegistrations = [...allRegistrations];
                filterByTime('all');
                return;
            }

            try {
                const params = new URLSearchParams();
                if (name) params.append('patient_name', name);
                if (phone) params.append('phone', phone);
                if (regId) params.append('reg_id', regId);

                filteredRegistrations = await apiRequest(`/doctor/search?${params.toString()}`);
                filterByTime('all');
            } catch (error) {
                showMessage('æœç´¢å¤±è´¥: ' + error.message, 'danger');
            }
        }

        function clearSearch() {
            document.getElementById('searchName').value = '';
            document.getElementById('searchPhone').value = '';
            document.getElementById('searchRegId').value = '';
            filteredRegistrations = [...allRegistrations];
            filterByTime('all');
        }

        function filterByTime(filter) {
            currentFilter = filter;
            
            // Update button styles
            document.querySelectorAll('[id^="filter"]').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            const buttonMap = {
                'active': 'filterActive',
                'completed': 'filterCompleted', 
                'today': 'filterToday',
                'all': 'filterAll'
            };
            document.getElementById(buttonMap[filter]).classList.remove('btn-secondary');
            document.getElementById(buttonMap[filter]).classList.add('btn-primary');

            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);

            let filtered = [...filteredRegistrations];

            switch (filter) {
                case 'active':
                    // æ˜¾ç¤ºæ‰€æœ‰æœªå®Œæˆçš„æŒ‚å·ï¼ˆregisteredçŠ¶æ€ï¼‰
                    filtered = filtered.filter(reg => reg.status === 'registered');
                    break;
                case 'completed':
                    // æ˜¾ç¤ºæ‰€æœ‰å·²å®Œæˆå’Œå·²è¿‡å·çš„æŒ‚å·ï¼ˆå†å²è®°å½•ï¼‰
                    filtered = filtered.filter(reg => reg.status === 'completed' || reg.status === 'cancelled');
                    break;
                case 'today':
                    filtered = filtered.filter(reg => {
                        const regDate = new Date(reg.reg_time);
                        return regDate >= today && regDate < tomorrow;
                    });
                    break;
                case 'all':
                default:
                    // No filtering needed
                    break;
            }

            displayPatients(filtered);
        }

        function displayPatients(registrations = filteredRegistrations) {
            const tbody = document.getElementById('patientsTable');
            const noPatients = document.getElementById('noPatients');
            
            tbody.innerHTML = '';
            
            if (registrations.length === 0) {
                noPatients.style.display = 'block';
            } else {
                noPatients.style.display = 'none';
                
                // Sort by appointment time
                registrations.sort((a, b) => new Date(a.reg_time) - new Date(b.reg_time));
                
                registrations.forEach(reg => {
                    const row = document.createElement('tr');
                    const regTime = new Date(reg.reg_time);
                    const now = new Date();
                    // åªèƒ½æ ‡è®°å½“å‰æ—¶é—´æˆ–è¿‡å»æ—¶é—´çš„registeredæŒ‚å·ä¸ºå·²å°±è¯Š
                    const canComplete = reg.status === 'registered' && regTime <= now;
                    
                    row.innerHTML = `
                        <td>${reg.reg_id}</td>
                        <td>${reg.patient_name}</td>
                        <td>${reg.patient_phone || 'æœªæä¾›'}</td>
                        <td>${formatDateTime(reg.reg_time)}</td>
                        <td><span class="status-badge status-${reg.status}">${getStatusText(reg.status)}</span></td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="showPatientDetails(${reg.reg_id})">è¯¦æƒ…</button>
                            ${canComplete ? 
                                `<button class="btn btn-success btn-sm" onclick="markCompletedDirect(${reg.reg_id})">æ ‡è®°å·²å°±è¯Š</button>` : 
                                ''
                            }
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        function showPatientDetails(regId) {
            const registration = allRegistrations.find(reg => reg.reg_id === regId);
            if (!registration) return;

            currentPatientId = regId;
            const modal = document.getElementById('patientModal');
            const details = document.getElementById('patientDetails');
            const completeBtn = document.getElementById('completeBtn');

            details.innerHTML = `
                <div class="form-group">
                    <strong>æŒ‚å·ID:</strong> ${registration.reg_id}
                </div>
                <div class="form-group">
                    <strong>æ‚£è€…å§“å:</strong> ${registration.patient_name}
                </div>
                <div class="form-group">
                    <strong>è”ç³»ç”µè¯:</strong> ${registration.patient_phone || 'æœªæä¾›'}
                </div>
                <div class="form-group">
                    <strong>é¢„çº¦æ—¶é—´:</strong> ${formatDateTime(registration.reg_time)}
                </div>
                <div class="form-group">
                    <strong>æŒ‚å·æ—¶é—´:</strong> ${formatDateTime(registration.created_at)}
                </div>
                <div class="form-group">
                    <strong>çŠ¶æ€:</strong> <span class="status-badge status-${registration.status}">${getStatusText(registration.status)}</span>
                </div>
            `;

            completeBtn.style.display = registration.status === 'registered' ? 'inline-block' : 'none';
            modal.style.display = 'block';
        }

        function closePatientModal() {
            document.getElementById('patientModal').style.display = 'none';
            currentPatientId = null;
        }

        async function markCompleted() {
            if (!currentPatientId) return;
            await markCompletedDirect(currentPatientId);
            closePatientModal();
        }

        async function markCompletedDirect(regId) {
            try {
                // Find the registration in the current view
                const registration = allRegistrations.find(reg => reg.reg_id === regId);
                if (!registration) {
                    throw new Error('æœªæ‰¾åˆ°è¯¥æŒ‚å·è®°å½•');
                }

                // Check if the appointment is today
                const regTime = new Date(registration.reg_time);
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);
                
                // Check if the appointment is in the future (not today)
                if (regTime >= tomorrow) {
                    showMessage('å°±è¯Šæ—¶é—´æœªåˆ°ï¼Œæ— æ³•æ ‡è®°ä¸ºå·²å°±è¯Š', 'warning');
                    return;
                }

                // Proceed with marking as completed
                await apiRequest(`/registrations/${regId}/complete`, {
                    method: 'POST'
                });

                showMessage('å·²æ ‡è®°ä¸ºå·²å°±è¯Š', 'success');
                // Only reload the patients list, not the stats
                const patientsContainer = document.getElementById('patientsContainer');
                patientsContainer.style.display = 'none';
                await loadPatients();
            } catch (error) {
                showMessage('æ“ä½œå¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'danger');
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'registered': 'å·²æŒ‚å·',
                'completed': 'å·²å°±è¯Š',
                'cancelled': 'å·²è¿‡å·'
            };
            return statusMap[status] || status;
        }

        function formatDateTime(dateTimeStr) {
            const date = new Date(dateTimeStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `alert alert-${type} message`;
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        // ç§»åŠ¨ç«¯èœå•æ§åˆ¶
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        // ç‚¹å‡»å¯¼èˆªé¡¹åè‡ªåŠ¨å…³é—­ç§»åŠ¨ç«¯èœå•
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    toggleSidebar();
                }
            });
        });

        async function loadDoctorStats() {
            try {
                const stats = await apiRequest('/doctor/stats');
                document.getElementById('totalMyPatients').textContent = stats.total_patients;
                document.getElementById('totalMyRegistrations').textContent = stats.total_registrations;
                document.getElementById('myActiveRegistrations').textContent = stats.active_registrations;
                document.getElementById('myCompletedRegistrations').textContent = stats.completed_registrations;
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        let myTrendChart = null;
        async function loadDoctorTrend() {
            try {
                const trendData = await apiRequest('/doctor/trend');
                
                if (myTrendChart) myTrendChart.destroy();
                
                const ctx = document.getElementById('myTrendChart').getContext('2d');
                myTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: trendData.labels,
                        datasets: [{
                            label: 'æŒ‚å·æ•°é‡',
                            data: trendData.data,
                            borderColor: '#36A2EB',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 5,
                            pointBackgroundColor: '#36A2EB',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `æŒ‚å·æ•°é‡: ${context.parsed.y}äºº`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    font: { size: 12 }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                ticks: {
                                    font: { size: 12 }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('åŠ è½½è¶‹åŠ¿å›¾å¤±è´¥:', error);
            }
        }

        async function loadProfile() {
            try {
                const profile = await apiRequest('/doctor/profile');
                document.getElementById('profileName').value = profile.name || '';
                document.getElementById('profileTitle').value = profile.title || 'æœªè®¾ç½®';
                document.getElementById('profileDept').value = profile.dept_name || '';
                document.getElementById('profilePassword').value = '';
                document.getElementById('profilePasswordConfirm').value = '';
                
                // åŠ è½½å¹¶æ˜¾ç¤ºå½“å‰åŒ»ç”Ÿç…§ç‰‡
                const photoPreview = document.getElementById('doctorPhotoPreview');
                
                console.log('Profile photo:', profile.photo); // è°ƒè¯•ä¿¡æ¯
                
                // åˆ›å»ºå ä½å›¾SVG
                const placeholderSvg = `data:image/svg+xml,%3Csvg width='180' height='240' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='180' height='240' fill='%23f8f9fa'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='16' fill='%23999' text-anchor='middle' dy='.3em'%3EåŒ»ç”Ÿç…§ç‰‡%3C/text%3E%3C/svg%3E`;
                
                if (profile.photo) {
                    // æœ‰ç…§ç‰‡ï¼šå°è¯•åŠ è½½å®é™…ç…§ç‰‡
                    const photoUrl = `${API_BASE_URL.replace('/api', '')}/uploads/${profile.photo}`;
                    console.log('Loading photo from:', photoUrl); // è°ƒè¯•ä¿¡æ¯
                    
                    photoPreview.src = photoUrl;
                    
                    // æ·»åŠ å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
                    photoPreview.onerror = function() {
                        console.error('Photo load failed, showing placeholder'); // è°ƒè¯•ä¿¡æ¯
                        this.src = placeholderSvg;
                        this.onerror = null; // é˜²æ­¢æ— é™å¾ªç¯
                    };
                    
                    photoPreview.onload = function() {
                        console.log('Photo loaded successfully'); // è°ƒè¯•ä¿¡æ¯
                    };
                } else {
                    // æ— ç…§ç‰‡ï¼šç›´æ¥æ˜¾ç¤ºå ä½å›¾
                    console.log('No photo, showing placeholder'); // è°ƒè¯•ä¿¡æ¯
                    photoPreview.src = placeholderSvg;
                }
            } catch (error) {
                showMessage('åŠ è½½ä¸ªäººä¿¡æ¯å¤±è´¥', 'danger');
            }
        }

        let selectedPhotoFile = null;

        function previewPhoto(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // éªŒè¯æ–‡ä»¶å¤§å°
            if (file.size > 2 * 1024 * 1024) {
                showMessage('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡2MB', 'warning');
                event.target.value = '';
                return;
            }
            
            // éªŒè¯æ–‡ä»¶ç±»å‹
            const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                showMessage('åªæ”¯æŒ PNGã€JPGã€JPEGã€GIF æ ¼å¼çš„å›¾ç‰‡', 'warning');
                event.target.value = '';
                return;
            }
            
            // é¢„è§ˆå›¾ç‰‡å¹¶éªŒè¯æ¯”ä¾‹å’Œå°ºå¯¸
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // éªŒè¯å›¾ç‰‡å°ºå¯¸
                    const minWidth = 300;
                    const minHeight = 400;
                    const maxWidth = 2000;
                    const maxHeight = 2667;
                    
                    if (img.width < minWidth || img.height < minHeight) {
                        showMessage(`ç…§ç‰‡å°ºå¯¸å¤ªå°ï¼æœ€å°å°ºå¯¸ä¸º${minWidth}Ã—${minHeight}åƒç´ ï¼Œå½“å‰ä¸º${img.width}Ã—${img.height}åƒç´ ã€‚`, 'warning');
                        event.target.value = '';
                        return;
                    }
                    
                    if (img.width > maxWidth || img.height > maxHeight) {
                        showMessage(`ç…§ç‰‡å°ºå¯¸å¤ªå¤§ï¼æœ€å¤§å°ºå¯¸ä¸º${maxWidth}Ã—${maxHeight}åƒç´ ï¼Œå½“å‰ä¸º${img.width}Ã—${img.height}åƒç´ ã€‚`, 'warning');
                        event.target.value = '';
                        return;
                    }
                    
                    // è®¡ç®—å›¾ç‰‡æ¯”ä¾‹
                    const ratio = img.width / img.height;
                    const targetRatio = 3 / 4; // 0.75
                    const tolerance = 0.1; // å…è®¸10%çš„è¯¯å·®
                    
                    // éªŒè¯æ¯”ä¾‹æ˜¯å¦æ¥è¿‘3:4
                    if (Math.abs(ratio - targetRatio) > tolerance) {
                        showMessage('ç…§ç‰‡æ¯”ä¾‹åº”ä¸º3:4ï¼ˆç«–ç‰ˆï¼‰ï¼Œä¾‹å¦‚600Ã—800åƒç´ ã€‚å½“å‰æ¯”ä¾‹ä¸ç¬¦åˆè¦æ±‚ã€‚', 'warning');
                        event.target.value = '';
                        return;
                    }
                    
                    // å°ºå¯¸å’Œæ¯”ä¾‹éƒ½ç¬¦åˆï¼Œæ˜¾ç¤ºé¢„è§ˆ
                    selectedPhotoFile = file;
                    document.getElementById('doctorPhotoPreview').src = e.target.result;
                    document.getElementById('uploadPhotoBtn').style.display = 'inline-block';
                    showMessage(`ç…§ç‰‡ç¬¦åˆè¦æ±‚ï¼ˆ${img.width}Ã—${img.height}åƒç´ ï¼‰`, 'success');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function uploadPhoto() {
            if (!selectedPhotoFile) {
                showMessage('è¯·å…ˆé€‰æ‹©ç…§ç‰‡', 'warning');
                return;
            }
            
            const formData = new FormData();
            formData.append('photo', selectedPhotoFile);
            
            try {
                const response = await fetch(`${API_BASE_URL}/doctor/photo`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    console.log('Upload response:', data); // è°ƒè¯•ä¿¡æ¯
                    showMessage('ç…§ç‰‡ä¸Šä¼ æˆåŠŸï¼', 'success');
                    document.getElementById('uploadPhotoBtn').style.display = 'none';
                    selectedPhotoFile = null;
                    
                    // æ›´æ–°é¢„è§ˆå›¾ç‰‡ä¸ºæœåŠ¡å™¨è¿”å›çš„URLï¼ˆä½¿ç”¨ä¸æ‚£è€…ç«¯ç›¸åŒçš„æ–¹å¼ï¼‰
                    if (data.photo) {
                        const photoPreview = document.getElementById('doctorPhotoPreview');
                        const photoUrl = `${API_BASE_URL.replace('/api', '')}/uploads/${data.photo}`;
                        console.log('Updating photo to:', photoUrl); // è°ƒè¯•ä¿¡æ¯
                        photoPreview.src = photoUrl;
                    }
                } else {
                    console.error('Upload failed:', data); // è°ƒè¯•ä¿¡æ¯
                    showMessage(data.error || 'ç…§ç‰‡ä¸Šä¼ å¤±è´¥', 'danger');
                }
            } catch (error) {
                showMessage('ç…§ç‰‡ä¸Šä¼ å¤±è´¥: ' + error.message, 'danger');
            }
        }

        async function updateProfile(event) {
            event.preventDefault();
            
            const password = document.getElementById('profilePassword').value;
            const passwordConfirm = document.getElementById('profilePasswordConfirm').value;
            
            if (password && password !== passwordConfirm) {
                showMessage('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'warning');
                return;
            }
            
            try {
                const data = {
                    name: document.getElementById('profileName').value
                };
                
                if (password) {
                    data.password = password;
                }
                
                await apiRequest('/doctor/profile', {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                
                showMessage('ä¸ªäººä¿¡æ¯æ›´æ–°æˆåŠŸ', 'success');
                
                // æ›´æ–°ä¾§è¾¹æ æ˜¾ç¤ºçš„ç”¨æˆ·å
                document.getElementById('username').textContent = data.name;
                localStorage.setItem('username', data.name);
                
                // æ¸…ç©ºå¯†ç å­—æ®µ
                document.getElementById('profilePassword').value = '';
                document.getElementById('profilePasswordConfirm').value = '';
            } catch (error) {
                showMessage('æ›´æ–°å¤±è´¥: ' + error.message, 'danger');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('role');
            localStorage.removeItem('username');
            localStorage.removeItem('user_id');
            window.location.href = 'login.html';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('patientModal');
            if (event.target === modal) {
                closePatientModal();
            }
        }


        // Initialize filter to show all appointments by default
        filterByTime('all');
    </script>
</body>
</html>
