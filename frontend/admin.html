<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜ç•Œé¢ - åŒ»é™¢æŒ‚å·ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/responsive.css">
    <link rel="stylesheet" href="assets/refresh-styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* æ•°æ®åº“ç®¡ç†æ ·å¼ */
        .db-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .btn-group {
            display: flex;
            gap: 10px;
        }
        .table-info {
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 14px;
        }
        .table-responsive {
            overflow-x: auto;
            max-height: 600px;
        }
        .pagination {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .pagination .btn {
            min-width: 40px;
        }
        #dataTable {
            font-size: 11px;
            table-layout: fixed;
            width: 100%;
        }
        #dataTable th {
            position: sticky;
            top: 0;
            background: #f8f9fa !important;
            z-index: 10;
            box-shadow: 0 2px 2px -1px rgba(0,0,0,0.1);
            font-size: 12px;
            padding: 8px 8px !important;
            text-align: center;
            border-bottom: 2px solid #dee2e6;
            font-weight: bold;
        }
        #dataTable td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 6px 8px !important;
            font-size: 11px;
            vertical-align: middle;
            border-bottom: 1px solid #f0f0f0;
        }
        #dataTable tr:hover {
            background-color: #f8f9fa;
        }
        #dataTable .btn-sm {
            font-size: 10px;
            padding: 2px 6px;
            margin: 0 1px;
        }
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        /* ç§»åŠ¨ç«¯å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            /* ä¾§è¾¹æ é€‚é… */
            .sidebar {
                width: 100% !important;
                height: auto !important;
                position: relative !important;
                transform: none !important;
            }
            
            .main-content {
                margin-left: 0 !important;
                padding: 10px !important;
            }
            
            /* å¯¼èˆªæ é€‚é… */
            .nav-item {
                padding: 8px 12px !important;
                font-size: 14px !important;
            }
            
            .nav-text {
                display: inline !important;
            }
            
            /* å¡ç‰‡é€‚é… */
            .card {
                margin: 10px 0 !important;
                padding: 15px !important;
            }
            
            /* è¡¨æ ¼é€‚é… */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            #dataTable {
                min-width: 600px;
                font-size: 10px !important;
            }
            
            #dataTable th {
                padding: 6px 4px !important;
                font-size: 10px !important;
            }
            
            #dataTable td {
                padding: 4px 4px !important;
                font-size: 9px !important;
            }
            
            #dataTable .btn-sm {
                font-size: 8px !important;
                padding: 1px 4px !important;
                margin: 0 1px !important;
            }
            
            /* æŒ‰é’®é€‚é… */
            .btn {
                padding: 8px 12px;
                font-size: 14px;
                margin: 2px;
            }
            
            .btn-group {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            /* è¡¨å•é€‚é… */
            .form-group {
                margin-bottom: 15px;
            }
            
            .form-control {
                font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
                padding: 12px;
            }
            
            /* æ•°æ®åº“é€‰æ‹©å™¨é€‚é… */
            .db-selector {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
                padding: 10px;
            }
            
            .db-selector .btn-group {
                justify-content: center;
            }
            
            /* ç»Ÿè®¡å¡ç‰‡é€‚é… */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }
            
            .stat-card {
                padding: 15px !important;
            }
            
            .stat-value {
                font-size: 24px !important;
            }
            
            /* å›¾è¡¨é€‚é… */
            .chart-container {
                height: 250px !important;
                margin: 10px 0;
            }
            
            /* æ¨¡æ€æ¡†é€‚é… */
            .modal-content {
                margin: 10px;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* åˆ†é¡µé€‚é… */
            .pagination {
                flex-wrap: wrap;
                justify-content: center;
                gap: 2px;
            }
            
            .pagination .btn {
                min-width: 35px;
                padding: 6px 8px;
                font-size: 12px;
            }
            
            /* éšè—ä¸é‡è¦çš„åˆ— */
            .mobile-hide {
                display: none !important;
            }
            
            /* æ“ä½œæŒ‰é’®å‚ç›´æ’åˆ— */
            .mobile-action-vertical .btn {
                display: block;
                width: 100%;
                margin: 1px 0;
                font-size: 10px;
                padding: 4px 8px;
            }
        }
        
        @media (max-width: 480px) {
            /* è¶…å°å±å¹•é€‚é… */
            .main-content {
                padding: 5px !important;
            }
            
            .card {
                padding: 10px !important;
                margin: 5px 0 !important;
            }
            
            #dataTable {
                min-width: 500px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr !important;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .db-selector .btn {
                width: 100%;
                margin: 2px 0;
            }
        }
        
        /* ç§»åŠ¨ç«¯èœå•æŒ‰é’®æ ·å¼ */
        .mobile-menu-btn {
            position: fixed;
            top: 60px;
            left: 15px;
            z-index: 1001;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,123,255,0.3);
            display: none;
            transition: all 0.3s ease;
        }
        
        .mobile-menu-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,123,255,0.4);
        }
        
        /* ä¾§è¾¹æ é®ç½©å±‚ */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        
        /* ç§»åŠ¨ç«¯æ˜¾ç¤ºèœå•æŒ‰é’® */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block !important;
            }
            
            .sidebar {
                position: fixed !important;
                top: 0;
                left: -100% !important;
                width: 280px !important;
                height: 100vh !important;
                z-index: 1000;
                transition: left 0.3s ease;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                box-shadow: 2px 0 15px rgba(0,0,0,0.2);
                border-right: 3px solid rgba(255,255,255,0.1);
            }
            
            .sidebar.mobile-open {
                left: 0 !important;
            }
            
            .sidebar-overlay.active {
                display: block;
            }
            
            /* ç§»åŠ¨ç«¯ä¾§è¾¹æ æ–‡å­—é¢œè‰² */
            .sidebar.mobile-open .nav-item {
                color: white !important;
                background: rgba(255,255,255,0.1) !important;
                border: 1px solid rgba(255,255,255,0.2) !important;
                margin: 5px 10px !important;
                border-radius: 8px !important;
            }
            
            .sidebar.mobile-open .nav-item:hover {
                background: rgba(255,255,255,0.2) !important;
                transform: translateX(5px);
            }
            
            .sidebar.mobile-open .nav-item.active {
                background: rgba(255,255,255,0.3) !important;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            }
            
            .sidebar.mobile-open .sidebar-header h2,
            .sidebar.mobile-open .sidebar-header p {
                color: white !important;
                text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            }
            
            .main-content {
                margin-left: 0 !important;
                padding-top: 80px !important;
            }
        }
    </style>
</head>
<body>
    <!-- æ¶ˆæ¯æç¤º -->
    <div id="message" class="alert" style="display: none;"></div>
    
    <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>

    <!-- ä¾§è¾¹æ é®ç½©å±‚ -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <div class="admin-layout">
        <!-- ä¾§è¾¹æ å¯¼èˆª -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>åŒ»é™¢æŒ‚å·ç³»ç»Ÿ</h2>
                <p class="sidebar-subtitle">ç®¡ç†å‘˜æ§åˆ¶å°</p>
            </div>
            
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" onclick="showSection('dashboard')">
                    <span class="nav-icon">ğŸ“Š</span>
                    <span class="nav-text">ç³»ç»Ÿæ¦‚è§ˆ</span>
                </a>
                <a href="#" class="nav-item" onclick="showSection('departments')">
                    <span class="nav-icon">ğŸ¥</span>
                    <span class="nav-text">ç§‘å®¤ç®¡ç†</span>
                </a>
                <a href="#" class="nav-item" onclick="showSection('titles')">
                    <span class="nav-icon">ğŸ–ï¸</span>
                    <span class="nav-text">èŒç§°ç®¡ç†</span>
                </a>
                <a href="#" class="nav-item" onclick="showSection('users')">
                    <span class="nav-icon">ğŸ‘¥</span>
                    <span class="nav-text">ç”¨æˆ·ç®¡ç†</span>
                </a>
                <a href="#" class="nav-item" onclick="showSection('registrations')">
                    <span class="nav-icon">ğŸ“‹</span>
                    <span class="nav-text">æŒ‚å·è®°å½•</span>
                </a>
                <a href="#" class="nav-item" onclick="showSection('schedule')">
                    <span class="nav-icon">ğŸ“…</span>
                    <span class="nav-text">æ’ç­ç®¡ç†</span>
                </a>
                <a href="#" class="nav-item" onclick="showSection('database')">
                    <span class="nav-icon">ğŸ—„ï¸</span>
                    <span class="nav-text">æ•°æ®åº“ç®¡ç†</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <span class="user-icon">ğŸ‘¤</span>
                    <div class="user-details">
                        <div class="user-name" id="username">admin</div>
                        <div class="user-role">ç®¡ç†å‘˜</div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <div class="content-header">
                <h1 id="pageTitle">ç³»ç»Ÿæ¦‚è§ˆ</h1>
            </div>
            
            <div class="content-body">
                <!-- ç³»ç»Ÿç»Ÿè®¡ -->
                <div id="section-dashboard" class="content-section active">
                    <div class="card">
            <h2>ç³»ç»Ÿç»Ÿè®¡</h2>
            <div class="grid grid-4">
                <div class="stats-card">
                    <h3 id="totalPatients">0</h3>
                    <p>æ€»æ‚£è€…æ•°</p>
                </div>
                <div class="stats-card">
                    <h3 id="totalDoctors">0</h3>
                    <p>æ€»åŒ»ç”Ÿæ•°</p>
                </div>
                <div class="stats-card">
                    <h3 id="totalDepartments">0</h3>
                    <p>ç§‘å®¤æ•°é‡</p>
                </div>
                <div class="stats-card">
                    <h3 id="totalRegistrations">0</h3>
                    <p>æ€»æŒ‚å·æ•°</p>
                </div>
            </div>
            <div class="grid grid-4 mt-2">
                <div class="stats-card">
                    <h3 id="activeRegistrations">0</h3>
                    <p>å¾…å°±è¯ŠæŒ‚å·</p>
                </div>
                <div class="stats-card">
                    <h3 id="completedRegistrations">0</h3>
                    <p>å·²å®ŒæˆæŒ‚å·</p>
                </div>
                <div class="stats-card">
                    <h3 id="totalFee">Â¥0.00</h3>
                    <p>ç´¯è®¡æŒ‚å·è´¹ç”¨</p>
                </div>
                <div class="stats-card">
                    <h3 id="monthlyFee">Â¥0.00</h3>
                    <p>è¿‘30å¤©è´¹ç”¨</p>
                </div>
                    </div>
                </div>

                <!-- ç»Ÿè®¡å›¾è¡¨ -->
                <div class="card mt-2">
                    <h2>æŒ‚å·æ•°æ®åˆ†æ</h2>
                    <div class="grid grid-2">
                        <div class="chart-container">
                            <h3 style="text-align: center; color: #666; margin-bottom: 1rem;">å„ç§‘å®¤æŒ‚å·åˆ†å¸ƒ</h3>
                            <canvas id="departmentChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h3 style="color: #666; margin: 0;">æŒ‚å·æ—¶é—´è¶‹åŠ¿</h3>
                                <button class="btn btn-secondary btn-sm" onclick="resetTimeChart()" title="é‡ç½®ä¸ºå…¨éƒ¨ç§‘å®¤">
                                    <span style="font-size: 16px;">ğŸ”„</span> é‡ç½®
                                </button>
                            </div>
                            <canvas id="timeChart"></canvas>
                        </div>
                    </div>
                </div>

                </div>

                <!-- ç§‘å®¤ç®¡ç† -->
                <div id="section-departments" class="content-section">
                    <div class="card">
            <div class="flex justify-between align-center mb-2">
                <h2>ç§‘å®¤ç®¡ç†</h2>
                <button class="btn btn-primary" onclick="showAddDepartmentModal()">æ·»åŠ ç§‘å®¤</button>
            </div>
            
            <!-- ç§‘å®¤æœç´¢ -->
            <div class="search-box mb-2">
                <input type="text" id="deptSearchInput" class="form-control" placeholder="æœç´¢ç§‘å®¤åç§°æˆ–ä½ç½®..." onkeyup="searchDepartments()">
            </div>
            
            <div class="loading" id="departmentsLoading">
                <div class="spinner"></div>
            </div>
            
            <div id="departmentsContainer" style="display: none;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ç§‘å®¤ID</th>
                            <th>ç§‘å®¤åç§°</th>
                            <th>ä½ç½®</th>
                            <th>åŒ»ç”Ÿæ•°é‡</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="departmentsTable">
                    </tbody>
                </table>
                    </div>
                </div>
                </div>

                <!-- èŒç§°ç®¡ç† -->
                <div id="section-titles" class="content-section">
                    <div class="card">
                        <div class="flex justify-between align-center mb-2">
                            <h2>èŒç§°ç®¡ç†</h2>
                            <button class="btn btn-primary" onclick="showAddTitleModal()">æ·»åŠ èŒç§°</button>
                        </div>
                        
                        <!-- èŒç§°æœç´¢ -->
                        <div class="search-box mb-2">
                            <input type="text" id="titleSearchInput" class="form-control" placeholder="æœç´¢èŒç§°åç§°..." onkeyup="searchTitles()">
                        </div>
                        
                        <div class="loading" id="titlesLoading">
                            <div class="spinner"></div>
                        </div>
                        
                        <div id="titlesContainer" style="display: none;">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>èŒç§°ID</th>
                                        <th>èŒç§°åç§°</th>
                                        <th>æŒ‚å·è´¹(å…ƒ)</th>
                                        <th>ä½¿ç”¨åŒ»ç”Ÿæ•°</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="titlesTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ç”¨æˆ·ç®¡ç† -->
                <div id="section-users" class="content-section">
                    <div class="card">
            <div class="flex justify-between align-center mb-2">
                <h2>ç”¨æˆ·ç®¡ç†</h2>
                <div>
                    <button class="btn btn-secondary btn-sm" onclick="showUserType('all')" id="showAll">å…¨éƒ¨</button>
                    <button class="btn btn-secondary btn-sm" onclick="showUserType('patients')" id="showPatients">æ‚£è€…</button>
                    <button class="btn btn-secondary btn-sm" onclick="showUserType('doctors')" id="showDoctors">åŒ»ç”Ÿ</button>
                    <button class="btn btn-secondary btn-sm" onclick="showUserType('admins')" id="showAdmins">ç®¡ç†å‘˜</button>
                    <button class="btn btn-primary btn-sm" onclick="showAddAdminModal()" id="addAdminBtn" style="display: none;">æ·»åŠ ç®¡ç†å‘˜</button>
                </div>
            </div>
            
            <!-- ç”¨æˆ·æœç´¢ -->
            <div class="search-box mb-2">
                <input type="text" id="userSearchInput" class="form-control" placeholder="æœç´¢ç”¨æˆ·åæˆ–å§“å..." onkeyup="searchUsers()">
            </div>
            
            <div class="loading" id="usersLoading">
                <div class="spinner"></div>
            </div>
            
            <div id="usersContainer" style="display: none;">
                <table class="table">
                    <thead id="usersTableHead">
                    </thead>
                    <tbody id="usersTable">
                    </tbody>
                </table>
                    </div>
                </div>
                </div>

                <!-- æŒ‚å·è®°å½•ç®¡ç† -->
                <div id="section-registrations" class="content-section">
                    <div class="card">
                        <h2>æŒ‚å·è®°å½•ç®¡ç†</h2>
                        
                        <!-- æŒ‚å·è®°å½•æœç´¢ -->
                        <div class="search-box mb-2">
                            <div class="form-row">
                                <div class="form-group">
                                    <input type="text" id="regPatientSearch" class="form-control" placeholder="æ‚£è€…å§“å" onkeyup="searchRegistrations()">
                                </div>
                                <div class="form-group">
                                    <input type="text" id="regDoctorSearch" class="form-control" placeholder="åŒ»ç”Ÿå§“å" onkeyup="searchRegistrations()">
                                </div>
                                <div class="form-group">
                                    <select id="regStatusFilter" class="form-control" onchange="searchRegistrations()">
                                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                        <option value="registered">å·²æŒ‚å·</option>
                                        <option value="completed">å·²å°±è¯Š</option>
                                        <option value="cancelled">å·²è¿‡å·</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="loading" id="registrationsLoading">
                            <div class="spinner"></div>
                        </div>
                        
                        <div id="registrationsContainer" style="display: none;">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>æŒ‚å·ID</th>
                                        <th>æ‚£è€…</th>
                                        <th>åŒ»ç”Ÿ</th>
                                        <th>ç§‘å®¤</th>
                                        <th>é¢„çº¦æ—¶é—´</th>
                                        <th>çŠ¶æ€</th>
                                        <th>åˆ›å»ºæ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="registrationsTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- æ’ç­ç®¡ç† -->
                <div id="section-schedule" class="content-section">
                    <div class="card">
                        <h2>åŒ»ç”Ÿæ’ç­ç®¡ç†</h2>
                        
                        <!-- æœç´¢æ¡† -->
                        <div class="search-box mb-2">
                            <div class="form-row">
                                <div class="form-group">
                                    <input type="text" id="scheduleSearchName" class="form-control" placeholder="åŒ»ç”Ÿå§“å" onkeyup="searchSchedule()">
                                </div>
                                <div class="form-group">
                                    <select id="scheduleSearchDept" class="form-control" onchange="searchSchedule()">
                                        <option value="">å…¨éƒ¨ç§‘å®¤</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <select id="scheduleSearchStatus" class="form-control" onchange="searchSchedule()">
                                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                        <option value="set">å·²è®¾ç½®</option>
                                        <option value="unset">æœªè®¾ç½®</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="loading" id="scheduleLoading">
                            <div class="spinner"></div>
                        </div>
                        
                        <div id="scheduleContainer" style="display: none;">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>åŒ»ç”Ÿ</th>
                                        <th>èŒç§°</th>
                                        <th>ç§‘å®¤</th>
                                        <th>æ’ç­çŠ¶æ€</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="scheduleTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- æ•°æ®åº“ç®¡ç† -->
                <div id="section-database" class="content-section">
                    <div class="card">
                        <h2>æ•°æ®åº“ç®¡ç†</h2>
                        
                        <!-- æ•°æ®åº“é€‰æ‹© -->
                        <div class="db-selector mb-2">
                            <div class="btn-group">
                                <button class="btn btn-primary active" onclick="selectDatabase('sqlite')" id="btn-db-sqlite">
                                    SQLite (ä¸»åº“)
                                </button>
                                <button class="btn btn-secondary" onclick="selectDatabase('mysql')" id="btn-db-mysql">
                                    MySQL (ä»åº“)
                                </button>
                                <button class="btn btn-secondary" onclick="selectDatabase('sqlserver')" id="btn-db-sqlserver">
                                    SQL Server (ä»åº“)
                                </button>
                            </div>
                            <button class="btn btn-warning" onclick="showConflicts()" style="margin-left: auto;">
                                ğŸ” æŸ¥çœ‹å†²çª
                            </button>
                        </div>

                        <!-- è¡¨æ ¼é€‰æ‹© -->
                        <div class="form-row mb-2">
                            <div class="form-group" style="flex: 1;">
                                <label>é€‰æ‹©è¡¨æ ¼:</label>
                                <select id="dbTableSelect" class="form-control" onchange="loadTableData()">
                                    <option value="">è¯·é€‰æ‹©è¡¨æ ¼</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button class="btn btn-info" onclick="compareAllDatabases()">
                                    å¯¹æ¯”ä¸‰åº“æ•°æ®
                                </button>
                            </div>
                        </div>

                        <!-- æ•°æ®è¡¨æ ¼ -->
                        <div class="loading" id="dbLoading" style="display: none;">
                            <div class="spinner"></div>
                        </div>

                        <div id="dbTableContainer" style="display: none;">
                            <div class="table-info mb-1">
                                <span>å½“å‰æ•°æ®åº“: <strong id="currentDatabase">SQLite</strong></span>
                                <span style="margin-left: 20px;">å½“å‰è¡¨: <strong id="currentTable">-</strong></span>
                                <span style="margin-left: 20px;">æ€»è®°å½•æ•°: <strong id="totalRecords">0</strong></span>
                            </div>

                            <div class="table-responsive">
                                <table class="table" id="dataTable">
                                    <thead id="dataTableHead">
                                    </thead>
                                    <tbody id="dataTableBody">
                                    </tbody>
                                </table>
                            </div>

                            <!-- åˆ†é¡µ -->
                            <div class="pagination" id="dbPagination">
                            </div>
                        </div>

                        <!-- å†²çªåˆ—è¡¨ -->
                        <div id="conflictContainer" style="display: none;">
                            <h3>æ•°æ®å†²çªåˆ—è¡¨</h3>
                            <div id="conflictList"></div>
                        </div>
                    </div>

                    <!-- æ•°æ®åº“åŒæ­¥é…ç½® -->
                    <div class="card" style="margin-top: 20px;">
                        <h2>æ•°æ®åº“åŒæ­¥é…ç½®</h2>
                        
                        <!-- è°ƒåº¦å™¨çŠ¶æ€ -->
                        <div class="sync-status mb-2" style="padding: 15px; background: #f5f5f5; border-radius: 8px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <h3 style="margin: 0 0 10px 0;">è‡ªåŠ¨åŒæ­¥è°ƒåº¦å™¨</h3>
                                    <div style="display: flex; align-items: center; gap: 20px;">
                                        <span>çŠ¶æ€: <strong id="schedulerStatus" style="color: #28a745;">â—</strong> <span id="schedulerStatusText">è¿è¡Œä¸­</span></span>
                                        <span>æ£€æŸ¥é—´éš”: <strong id="currentInterval">10åˆ†é’Ÿ</strong></span>
                                    </div>
                                </div>
                                <div>
                                    <button class="btn" id="schedulerToggleBtn" onclick="toggleScheduler()">
                                        <span id="schedulerBtnIcon">â¸</span> <span id="schedulerBtnText">æš‚åœè°ƒåº¦å™¨</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- é…ç½®è¡¨å• -->
                        <div class="form-row mb-2">
                            <div class="form-group" style="flex: 1;">
                                <label>è‡ªåŠ¨æ£€æŸ¥é—´éš” (åˆ†é’Ÿ):</label>
                                <input type="number" id="checkIntervalInput" class="form-control" min="0.17" max="1440" step="0.1" value="10" placeholder="0.17-1440åˆ†é’Ÿ">
                                <small style="color: #666;">å»ºè®®: 0.5-2åˆ†é’Ÿ(é¢‘ç¹), 5-10åˆ†é’Ÿ(å¹³è¡¡), 30åˆ†é’Ÿä»¥ä¸Š(ä¸é¢‘ç¹)ã€‚æœ€å°10ç§’(0.17åˆ†é’Ÿ)</small>
                            </div>
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button class="btn btn-primary" onclick="updateSyncInterval()">
                                    ğŸ’¾ ä¿å­˜é—´éš”è®¾ç½®
                                </button>
                            </div>
                        </div>

                        <!-- é»˜è®¤åŒæ­¥ç­–ç•¥ -->
                        <div class="form-group mb-2">
                            <label>é»˜è®¤åŒæ­¥ç­–ç•¥:</label>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <div class="strategy-option" style="padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;" onclick="selectStrategy('timestamp_priority')">
                                    <input type="radio" name="syncStrategy" value="timestamp_priority" checked style="margin-right: 8px;">
                                    <strong>æ—¶é—´æˆ³ä¼˜å…ˆ</strong>
                                    <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #666;">è‡ªåŠ¨é€‰æ‹©æœ€æ–°çš„æ•°æ®ï¼ˆæ ¹æ®updated_atå­—æ®µï¼‰</p>
                                </div>
                                <div class="strategy-option" style="padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;" onclick="selectStrategy('primary_priority')">
                                    <input type="radio" name="syncStrategy" value="primary_priority" style="margin-right: 8px;">
                                    <strong>SQLiteä¼˜å…ˆ</strong>
                                    <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #666;">å§‹ç»ˆä½¿ç”¨SQLiteæ•°æ®åº“çš„æ•°æ®</p>
                                </div>
                                <div class="strategy-option" style="padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;" onclick="selectStrategy('mysql_priority')">
                                    <input type="radio" name="syncStrategy" value="mysql_priority" style="margin-right: 8px;">
                                    <strong>MySQLä¼˜å…ˆ</strong>
                                    <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #666;">å§‹ç»ˆä½¿ç”¨MySQLæ•°æ®åº“çš„æ•°æ®</p>
                                </div>
                                <div class="strategy-option" style="padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;" onclick="selectStrategy('sqlserver_priority')">
                                    <input type="radio" name="syncStrategy" value="sqlserver_priority" style="margin-right: 8px;">
                                    <strong>SQL Serverä¼˜å…ˆ</strong>
                                    <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #666;">å§‹ç»ˆä½¿ç”¨SQL Serveræ•°æ®åº“çš„æ•°æ®</p>
                                </div>
                            </div>
                        </div>

                        <!-- æ‰‹åŠ¨åŒæ­¥ -->
                        <div style="padding: 15px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107;">
                            <h3 style="margin: 0 0 10px 0;">æ‰‹åŠ¨è§¦å‘åŒæ­¥</h3>
                            <p style="margin: 0 0 10px 0; color: #856404;">ç«‹å³æ‰§è¡Œä¸€æ¬¡å®Œæ•´çš„æ•°æ®åº“åŒæ­¥ï¼Œä½¿ç”¨ä¸Šé¢é€‰æ‹©çš„ç­–ç•¥</p>
                            <button class="btn btn-warning" onclick="manualSync()" style="width: 100%;">
                                ğŸ”„ ç«‹å³åŒæ­¥æ‰€æœ‰æ•°æ®åº“
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- æ·»åŠ ç§‘å®¤æ¨¡æ€æ¡† -->
    <div id="addDepartmentModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ ç§‘å®¤</h3>
                <span class="close" onclick="closeAddDepartmentModal()">&times;</span>
            </div>
            <form id="addDepartmentForm">
                <div class="form-group">
                    <label for="deptName">ç§‘å®¤åç§°</label>
                    <input type="text" id="deptName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="deptLocation">ç§‘å®¤ä½ç½®</label>
                    <input type="text" id="deptLocation" class="form-control" required>
                </div>
                <div style="text-align: right; margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddDepartmentModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">æ·»åŠ </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç¼–è¾‘ç§‘å®¤æ¨¡æ€æ¡† -->
    <div id="editDepartmentModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¼–è¾‘ç§‘å®¤</h3>
                <span class="close" onclick="closeEditDepartmentModal()">&times;</span>
            </div>
            <form id="editDepartmentForm">
                <div class="form-group">
                    <label for="editDeptName">ç§‘å®¤åç§°</label>
                    <input type="text" id="editDeptName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editDeptLocation">ç§‘å®¤ä½ç½®</label>
                    <input type="text" id="editDeptLocation" class="form-control" required>
                </div>
                <div style="text-align: right; margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditDepartmentModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç¡®è®¤åˆ é™¤æ¨¡æ€æ¡† -->
    <div id="confirmDeleteModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¡®è®¤åˆ é™¤</h3>
                <span class="close" onclick="closeConfirmDeleteModal()">&times;</span>
            </div>
            <p id="deleteMessage">ç¡®å®šè¦åˆ é™¤å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚</p>
            <div style="text-align: right; margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="closeConfirmDeleteModal()">å–æ¶ˆ</button>
                <button class="btn btn-danger" onclick="confirmDelete()">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ ç®¡ç†å‘˜æ¨¡æ€æ¡† -->
    <div id="addAdminModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ ç®¡ç†å‘˜</h3>
                <span class="close" onclick="closeAddAdminModal()">&times;</span>
            </div>
            <form id="addAdminForm">
                <div class="form-group">
                    <label for="adminUsername">ç”¨æˆ·å <span style="color: red;">*</span></label>
                    <input type="text" id="adminUsername" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="adminPassword">å¯†ç  <span style="color: red;">*</span></label>
                    <input type="password" id="adminPassword" class="form-control" required>
                    <small style="color: #666;">å¯†ç é•¿åº¦è‡³å°‘6ä½</small>
                </div>
                <div class="form-group">
                    <label for="adminEmail">é‚®ç®±åœ°å€</label>
                    <input type="email" id="adminEmail" class="form-control" placeholder="example@qq.com">
                    <small style="color: #666;">ç”¨äºæ¥æ”¶æ•°æ®åº“åŒæ­¥å†²çªé€šçŸ¥é‚®ä»¶</small>
                </div>
                <div style="text-align: right; margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddAdminModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">æ·»åŠ </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç¼–è¾‘ç®¡ç†å‘˜æ¨¡æ€æ¡† -->
    <div id="editAdminModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¼–è¾‘ç®¡ç†å‘˜</h3>
                <span class="close" onclick="closeEditAdminModal()">&times;</span>
            </div>
            <form id="editAdminForm">
                <input type="hidden" id="editAdminId">
                <div class="form-group">
                    <label for="editAdminUsername">ç”¨æˆ·å</label>
                    <input type="text" id="editAdminUsername" class="form-control" disabled style="background: #f5f5f5;">
                    <small style="color: #666;">ç”¨æˆ·åä¸å¯ä¿®æ”¹</small>
                </div>
                <div class="form-group">
                    <label for="editAdminEmail">é‚®ç®±åœ°å€</label>
                    <input type="email" id="editAdminEmail" class="form-control" placeholder="example@qq.com">
                    <small style="color: #666;">ç”¨äºæ¥æ”¶æ•°æ®åº“åŒæ­¥å†²çªé€šçŸ¥é‚®ä»¶</small>
                </div>
                <div class="form-group">
                    <label for="editAdminPassword">æ–°å¯†ç </label>
                    <input type="password" id="editAdminPassword" class="form-control" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹å¯†ç ">
                    <small style="color: #666;">å¦‚éœ€ä¿®æ”¹å¯†ç ï¼Œè¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰</small>
                </div>
                <div style="text-align: right; margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditAdminModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ·»åŠ èŒç§°æ¨¡æ€æ¡† -->
    <div id="addTitleModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ èŒç§°</h3>
                <span class="close" onclick="closeAddTitleModal()">&times;</span>
            </div>
            <form id="addTitleForm">
                <div class="form-group">
                    <label for="titleName">èŒç§°åç§°ï¼š</label>
                    <input type="text" id="titleName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="registrationFee">æŒ‚å·è´¹(å…ƒ)ï¼š</label>
                    <input type="number" id="registrationFee" class="form-control" step="0.01" min="0" required>
                </div>
                <div style="text-align: right; margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddTitleModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">æ·»åŠ </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç¼–è¾‘èŒç§°æ¨¡æ€æ¡† -->
    <div id="editTitleModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¼–è¾‘èŒç§°</h3>
                <span class="close" onclick="closeEditTitleModal()">&times;</span>
            </div>
            <form id="editTitleForm">
                <input type="hidden" id="editTitleId">
                <div class="form-group">
                    <label for="editTitleName">èŒç§°åç§°ï¼š</label>
                    <input type="text" id="editTitleName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editRegistrationFee">æŒ‚å·è´¹(å…ƒ)ï¼š</label>
                    <input type="number" id="editRegistrationFee" class="form-control" step="0.01" min="0" required>
                </div>
                <div style="text-align: right; margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditTitleModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç¼–è¾‘æ‚£è€…æ¨¡æ€æ¡† -->
    <div id="editPatientModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¼–è¾‘æ‚£è€…ä¿¡æ¯</h3>
                <span class="close" onclick="closeEditPatientModal()">&times;</span>
            </div>
            <form id="editPatientForm">
                <input type="hidden" id="editPatientId">
                <div class="form-group">
                    <label for="editPatientName">å§“å</label>
                    <input type="text" id="editPatientName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editPatientPhone">ç”µè¯</label>
                    <input type="text" id="editPatientPhone" class="form-control" maxlength="11">
                </div>
                <div class="form-group">
                    <label for="editPatientGender">æ€§åˆ«</label>
                    <select id="editPatientGender" class="form-control">
                        <option value="">æœªè®¾ç½®</option>
                        <option value="ç”·">ç”·</option>
                        <option value="å¥³">å¥³</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editPatientBirthday">ç”Ÿæ—¥</label>
                    <input type="date" id="editPatientBirthday" class="form-control">
                </div>
                <div style="text-align: right; margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditPatientModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç¼–è¾‘åŒ»ç”Ÿæ¨¡æ€æ¡† -->
    <div id="editDoctorModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¼–è¾‘åŒ»ç”Ÿä¿¡æ¯</h3>
                <span class="close" onclick="closeEditDoctorModal()">&times;</span>
            </div>
            <form id="editDoctorForm">
                <input type="hidden" id="editDoctorId">
                <div class="form-group">
                    <label for="editDoctorName">å§“å</label>
                    <input type="text" id="editDoctorName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editDoctorTitle">èŒç§°</label>
                    <select id="editDoctorTitle" class="form-control" required>
                        <option value="">è¯·é€‰æ‹©èŒç§°</option>
                        <!-- èŒç§°é€‰é¡¹å°†åŠ¨æ€åŠ è½½ -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="editDoctorDept">ç§‘å®¤</label>
                    <select id="editDoctorDept" class="form-control" required>
                    </select>
                </div>
                <div style="text-align: right; margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditDoctorModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç¼–è¾‘æŒ‚å·è®°å½•æ¨¡æ€æ¡† -->
    <div id="editRegistrationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¼–è¾‘æŒ‚å·è®°å½•</h3>
                <span class="close" onclick="closeEditRegistrationModal()">&times;</span>
            </div>
            <form id="editRegistrationForm">
                <input type="hidden" id="editRegId">
                <div class="form-group">
                    <label for="editRegPatient">æ‚£è€…</label>
                    <input type="text" id="editRegPatient" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="editRegDoctor">åŒ»ç”Ÿ</label>
                    <input type="text" id="editRegDoctor" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="editRegTime">é¢„çº¦æ—¶é—´</label>
                    <input type="datetime-local" id="editRegTime" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="editRegStatus">çŠ¶æ€</label>
                    <select id="editRegStatus" class="form-control" required>
                        <option value="registered">å·²æŒ‚å·</option>
                        <option value="completed">å·²å°±è¯Š</option>
                        <option value="cancelled">å·²è¿‡å·</option>
                    </select>
                </div>
                <div style="text-align: right; margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditRegistrationModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç§‘å®¤æŒ‚å·è®°å½•è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="deptRegistrationsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="deptModalTitle">ç§‘å®¤æŒ‚å·è®°å½•</h3>
                <span class="close" onclick="closeDeptRegistrationsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="loading" id="deptRegLoading">
                    <div class="spinner"></div>
                </div>
                <div id="deptRegContainer" style="display: none;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>æŒ‚å·ID</th>
                                <th>æ‚£è€…</th>
                                <th>åŒ»ç”Ÿ</th>
                                <th>é¢„çº¦æ—¶é—´</th>
                                <th>çŠ¶æ€</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody id="deptRegTable">
                        </tbody>
                    </table>
                    <p id="noDataMessage" style="text-align: center; color: #999; padding: 2rem; display: none;">
                        è¯¥ç§‘å®¤æš‚æ— æŒ‚å·è®°å½•
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘æ’ç­æ¨¡æ€æ¡† -->
    <div id="editScheduleModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>ç¼–è¾‘åŒ»ç”Ÿæ’ç­</h3>
                <span class="close" onclick="closeEditScheduleModal()">&times;</span>
            </div>
            <div class="modal-body">
                <h4 id="scheduleDocName" style="margin-bottom: 1.5rem; color: #333;"></h4>
                
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <p style="margin: 0; color: #666; font-size: 0.9rem;">
                        âœ“ å‹¾é€‰è¡¨ç¤ºè¯¥æ—¶æ®µå¯é¢„çº¦ &nbsp;&nbsp; âœ— ä¸å‹¾é€‰è¡¨ç¤ºè¯¥æ—¶æ®µä¸å¯é¢„çº¦
                    </p>
                </div>
                
                <table class="table" style="margin-bottom: 0;">
                    <thead>
                        <tr>
                            <th style="width: 120px;">æ˜ŸæœŸ</th>
                            <th style="text-align: center;">ä¸Šåˆ</th>
                            <th style="text-align: center;">ä¸‹åˆ</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleGrid">
                        <tr>
                            <td><strong>å‘¨ä¸€</strong></td>
                            <td style="text-align: center;"><input type="checkbox" id="monday_am" class="schedule-checkbox"></td>
                            <td style="text-align: center;"><input type="checkbox" id="monday_pm" class="schedule-checkbox"></td>
                        </tr>
                        <tr>
                            <td><strong>å‘¨äºŒ</strong></td>
                            <td style="text-align: center;"><input type="checkbox" id="tuesday_am" class="schedule-checkbox"></td>
                            <td style="text-align: center;"><input type="checkbox" id="tuesday_pm" class="schedule-checkbox"></td>
                        </tr>
                        <tr>
                            <td><strong>å‘¨ä¸‰</strong></td>
                            <td style="text-align: center;"><input type="checkbox" id="wednesday_am" class="schedule-checkbox"></td>
                            <td style="text-align: center;"><input type="checkbox" id="wednesday_pm" class="schedule-checkbox"></td>
                        </tr>
                        <tr>
                            <td><strong>å‘¨å››</strong></td>
                            <td style="text-align: center;"><input type="checkbox" id="thursday_am" class="schedule-checkbox"></td>
                            <td style="text-align: center;"><input type="checkbox" id="thursday_pm" class="schedule-checkbox"></td>
                        </tr>
                        <tr>
                            <td><strong>å‘¨äº”</strong></td>
                            <td style="text-align: center;"><input type="checkbox" id="friday_am" class="schedule-checkbox"></td>
                            <td style="text-align: center;"><input type="checkbox" id="friday_pm" class="schedule-checkbox"></td>
                        </tr>
                        <tr>
                            <td><strong>å‘¨å…­</strong></td>
                            <td style="text-align: center;"><input type="checkbox" id="saturday_am" class="schedule-checkbox"></td>
                            <td style="text-align: center;"><input type="checkbox" id="saturday_pm" class="schedule-checkbox"></td>
                        </tr>
                        <tr>
                            <td><strong>å‘¨æ—¥</strong></td>
                            <td style="text-align: center;"><input type="checkbox" id="sunday_am" class="schedule-checkbox"></td>
                            <td style="text-align: center;"><input type="checkbox" id="sunday_pm" class="schedule-checkbox"></td>
                        </tr>
                    </tbody>
                </table>
                
                <div style="text-align: right; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditScheduleModal()">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveSchedule()">ä¿å­˜æ’ç­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘æ•°æ®æ¨¡æ€æ¡† -->
    <div id="editDataModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¼–è¾‘æ•°æ®</h3>
                <span class="close" onclick="closeEditDataModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="editDataForm"></div>
                <div style="text-align: right; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditDataModal()">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveDataChanges()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å†²çªè§£å†³æ¨¡æ€æ¡† -->
    <div id="conflictResolveModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>è§£å†³æ•°æ®å†²çª</h3>
                <span class="close" onclick="closeConflictResolveModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="conflictDetails"></div>
                
                <div class="form-group mt-2">
                    <label>é€‰æ‹©è§£å†³ç­–ç•¥:</label>
                    <select id="conflictStrategy" class="form-control">
                        <option value="timestamp_priority">æ—¶é—´æˆ³ä¼˜å…ˆ - é€‰æ‹©æœ€æ–°ä¿®æ”¹çš„æ•°æ®</option>
                        <option value="primary_priority">ä¸»æ•°æ®åº“ä¼˜å…ˆ - ä½¿ç”¨SQLiteæ•°æ®</option>
                        <option value="mysql_priority">MySQLä¼˜å…ˆ - ä½¿ç”¨MySQLæ•°æ®</option>
                        <option value="sqlserver_priority">SQL Serverä¼˜å…ˆ - ä½¿ç”¨SQL Serveræ•°æ®</option>
                        <option value="delete_all" style="color: #dc3545;">ğŸ—‘ï¸ åˆ é™¤æ‰€æœ‰è®°å½• - ä»æ‰€æœ‰æ•°æ®åº“ä¸­åˆ é™¤æ­¤è®°å½•</option>
                    </select>
                </div>
                
                <div style="text-align: right; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeConflictResolveModal()">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="executeConflictResolution()">æ‰§è¡Œè§£å†³</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="deleteConfirmModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>ç¡®è®¤åˆ é™¤</h3>
                <span class="close" onclick="closeDeleteConfirmModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="padding: 20px; text-align: center;">
                    <div style="font-size: 48px; color: #e74c3c; margin-bottom: 15px;">âš ï¸</div>
                    <h4 style="color: #e74c3c; margin-bottom: 10px;">è­¦å‘Šï¼šæ­¤æ“ä½œä¸å¯æ¢å¤ï¼</h4>
                    <p style="margin-bottom: 15px;">æ‚¨ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ</p>
                    <div id="deleteRecordInfo" style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 15px; text-align: left;">
                    </div>
                    <p style="color: #666; font-size: 14px;">
                        <strong>æ•°æ®åº“:</strong> <span id="deleteDatabase"></span><br>
                        <strong>è¡¨å:</strong> <span id="deleteTable"></span>
                    </p>
                </div>
                
                <div style="text-align: right; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteConfirmModal()">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDatabaseDelete()">ç¡®è®¤åˆ é™¤</button>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/config.js?v=2.6"></script>
    <script>
        let currentEditDeptId = null;
        let currentDeleteAction = null;
        let currentUserType = 'all';

        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            if (!localStorage.getItem('token') || localStorage.getItem('role') !== 'admin') {
                window.location.href = 'login.html';
                return;
            }

            // Set username
            const usernameElements = document.querySelectorAll('#username');
            usernameElements.forEach(el => {
                el.textContent = localStorage.getItem('username');
            });

            // Load initial data for dashboard only
            loadStats();

            // Set up form event listeners
            document.getElementById('addDepartmentForm').addEventListener('submit', handleAddDepartment);
            document.getElementById('editDepartmentForm').addEventListener('submit', handleEditDepartment);
            document.getElementById('addAdminForm').addEventListener('submit', handleAddAdmin);
            document.getElementById('editAdminForm').addEventListener('submit', handleEditAdmin);
            document.getElementById('editPatientForm').addEventListener('submit', handleEditPatient);
            document.getElementById('editDoctorForm').addEventListener('submit', handleEditDoctor);
            document.getElementById('editRegistrationForm').addEventListener('submit', handleEditRegistration);
        });

        // å›¾è¡¨å®ä¾‹
        let departmentChart = null;
        let timeChart = null;

        async function loadStats() {
            try {
                const stats = await apiRequest('/admin/stats');
                
                document.getElementById('totalPatients').textContent = stats.total_patients;
                document.getElementById('totalDoctors').textContent = stats.total_doctors;
                document.getElementById('totalDepartments').textContent = stats.total_departments;
                document.getElementById('totalRegistrations').textContent = stats.total_registrations;
                document.getElementById('activeRegistrations').textContent = stats.active_registrations;
                document.getElementById('completedRegistrations').textContent = stats.completed_registrations;
                
                // æ˜¾ç¤ºæŒ‚å·è´¹ç”¨ç»Ÿè®¡
                const totalFee = stats.total_fee || 0;
                const monthlyFee = stats.monthly_fee || 0;
                document.getElementById('totalFee').textContent = `Â¥${totalFee.toFixed(2)}`;
                document.getElementById('monthlyFee').textContent = `Â¥${monthlyFee.toFixed(2)}`;
                
                // åŠ è½½å›¾è¡¨æ•°æ®
                loadCharts();
            } catch (error) {
                showMessage('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥: ' + error.message, 'danger');
            }
        }

        async function loadCharts() {
            try {
                const chartData = await apiRequest('/admin/chart-data');
                console.log('Chart data received:', chartData);
                
                // æ£€æŸ¥æ•°æ®æ˜¯å¦æœ‰æ•ˆ
                if (!chartData || !chartData.department || !chartData.time) {
                    console.error('Invalid chart data:', chartData);
                    showMessage('å›¾è¡¨æ•°æ®æ ¼å¼é”™è¯¯', 'danger');
                    return;
                }
                
                // é”€æ¯æ—§å›¾è¡¨
                if (departmentChart) departmentChart.destroy();
                if (timeChart) timeChart.destroy();
                
                // åˆ›å»ºç§‘å®¤åˆ†å¸ƒé¥¼å›¾
                const deptCtx = document.getElementById('departmentChart').getContext('2d');
                departmentChart = new Chart(deptCtx, {
                    type: 'pie',
                    data: {
                        labels: chartData.department.labels,
                        datasets: [{
                            label: 'æŒ‚å·æ•°é‡',
                            data: chartData.department.data,
                            backgroundColor: [
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56',
                                '#4BC0C0',
                                '#9966FF',
                                '#FF9F40',
                                '#FF6384',
                                '#C9CBCF'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${value}äºº (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const deptName = chartData.department.labels[index];
                                showDeptRegistrations(deptName);
                            }
                        },
                        onHover: (event, elements) => {
                            event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                        }
                    }
                });
                
                // åˆ›å»ºæ—¶é—´è¶‹åŠ¿æŠ˜çº¿å›¾
                const timeCtx = document.getElementById('timeChart').getContext('2d');
                timeChart = new Chart(timeCtx, {
                    type: 'line',
                    data: {
                        labels: chartData.time.labels,
                        datasets: [{
                            label: 'æŒ‚å·æ•°é‡',
                            data: chartData.time.data,
                            borderColor: '#36A2EB',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 5,
                            pointBackgroundColor: '#36A2EB',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `æŒ‚å·æ•°é‡: ${context.parsed.y}äºº`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    font: {
                                        size: 12
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 12
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('åŠ è½½å›¾è¡¨æ•°æ®å¤±è´¥:', error);
            }
        }

        async function loadDepartments() {
            const loading = document.getElementById('departmentsLoading');
            const container = document.getElementById('departmentsContainer');
            
            loading.style.display = 'flex';
            container.style.display = 'none';

            try {
                const [departments, doctors] = await Promise.all([
                    apiRequest('/departments'),
                    apiRequest('/admin/doctors')
                ]);

                const tbody = document.getElementById('departmentsTable');
                tbody.innerHTML = '';

                departments.forEach(dept => {
                    const doctorCount = doctors.filter(doc => doc.dept_id === dept.dept_id).length;
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${dept.dept_id}</td>
                        <td>${dept.dept_name}</td>
                        <td>${dept.location}</td>
                        <td>${doctorCount}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="showEditDepartmentModal(${dept.dept_id}, '${dept.dept_name}', '${dept.location}')">ç¼–è¾‘</button>
                            <button class="btn btn-danger btn-sm" onclick="showDeleteDepartmentModal(${dept.dept_id}, '${dept.dept_name}', ${doctorCount})">åˆ é™¤</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                container.style.display = 'block';
            } catch (error) {
                showMessage('åŠ è½½ç§‘å®¤æ•°æ®å¤±è´¥: ' + error.message, 'danger');
            } finally {
                loading.style.display = 'none';
            }
        }

        async function loadUsers(type) {
            currentUserType = type;
            const loading = document.getElementById('usersLoading');
            const container = document.getElementById('usersContainer');
            
            // Update button styles
            document.getElementById('showAll').classList.remove('btn-primary');
            document.getElementById('showAll').classList.add('btn-secondary');
            document.getElementById('showPatients').classList.remove('btn-primary');
            document.getElementById('showPatients').classList.add('btn-secondary');
            document.getElementById('showDoctors').classList.remove('btn-primary');
            document.getElementById('showDoctors').classList.add('btn-secondary');
            document.getElementById('showAdmins').classList.remove('btn-primary');
            document.getElementById('showAdmins').classList.add('btn-secondary');
            
            // Show/hide add admin button
            const addAdminBtn = document.getElementById('addAdminBtn');
            if (type === 'admins') {
                addAdminBtn.style.display = 'inline-block';
                document.getElementById('showAdmins').classList.remove('btn-secondary');
                document.getElementById('showAdmins').classList.add('btn-primary');
            } else {
                addAdminBtn.style.display = 'none';
                if (type === 'all') {
                    document.getElementById('showAll').classList.remove('btn-secondary');
                    document.getElementById('showAll').classList.add('btn-primary');
                } else if (type === 'patients') {
                    document.getElementById('showPatients').classList.remove('btn-secondary');
                    document.getElementById('showPatients').classList.add('btn-primary');
                } else if (type === 'doctors') {
                    document.getElementById('showDoctors').classList.remove('btn-secondary');
                    document.getElementById('showDoctors').classList.add('btn-primary');
                }
            }
            
            loading.style.display = 'flex';
            container.style.display = 'none';

            try {
                let users = [];
                
                // Load all users if type is 'all'
                if (type === 'all') {
                    const [patients, doctors, admins] = await Promise.all([
                        apiRequest('/admin/patients'),
                        apiRequest('/admin/doctors'),
                        apiRequest('/admin/admins')
                    ]);
                    
                    // Add type field to each user
                    patients.forEach(u => u.userType = 'patient');
                    doctors.forEach(u => u.userType = 'doctor');
                    admins.forEach(u => u.userType = 'admin');
                    
                    users = [...patients, ...doctors, ...admins];
                } else {
                    users = await apiRequest(`/admin/${type}`);
                }
                const thead = document.getElementById('usersTableHead');
                const tbody = document.getElementById('usersTable');
                
                tbody.innerHTML = '';

                if (type === 'patients') {
                    thead.innerHTML = `
                        <tr>
                            <th>æ‚£è€…ID</th>
                            <th>ç”¨æˆ·å</th>
                            <th>å§“å</th>
                            <th>ç”µè¯</th>
                            <th>æ€§åˆ«</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    `;
                    
                    users.forEach(user => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.patient_id}</td>
                            <td>${user.username}</td>
                            <td>${user.name}</td>
                            <td>${user.phone || 'æœªæä¾›'}</td>
                            <td>${user.gender || 'æœªè®¾ç½®'}</td>
                            <td>
                                <button class="btn btn-warning btn-sm" onclick='showEditPatientModal(${JSON.stringify(user)})'>ç¼–è¾‘</button>
                                <button class="btn btn-danger btn-sm" onclick="showDeleteUserModal('patient', ${user.patient_id}, '${user.name}')">åˆ é™¤</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else if (type === 'doctors') {
                    thead.innerHTML = `
                        <tr>
                            <th>åŒ»ç”ŸID</th>
                            <th>ç”¨æˆ·å</th>
                            <th>å§“å</th>
                            <th>èŒç§°</th>
                            <th>ç§‘å®¤</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    `;
                    
                    users.forEach(user => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.doctor_id}</td>
                            <td>${user.username}</td>
                            <td>${user.name}</td>
                            <td>${user.title || 'æœªè®¾ç½®'}</td>
                            <td>${user.dept_name || 'æœªçŸ¥ç§‘å®¤'}</td>
                            <td>
                                <button class="btn btn-warning btn-sm" onclick='showEditDoctorModal(${JSON.stringify(user)})'>ç¼–è¾‘</button>
                                <button class="btn btn-danger btn-sm" onclick="showDeleteUserModal('doctor', ${user.doctor_id}, '${user.name}')">åˆ é™¤</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else if (type === 'admins') {
                    thead.innerHTML = `
                        <tr>
                            <th>ç®¡ç†å‘˜ID</th>
                            <th>ç”¨æˆ·å</th>
                            <th>é‚®ç®±</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    `;
                    
                    users.forEach(user => {
                        const currentUserId = parseInt(localStorage.getItem('user_id'));
                        const canEdit = user.admin_id <= currentUserId;
                        const canDelete = user.admin_id > currentUserId;
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.admin_id}</td>
                            <td>${user.username}</td>
                            <td>${user.email || '<span style="color: #999;">æœªè®¾ç½®</span>'}</td>
                            <td>${user.created_at ? new Date(user.created_at).toLocaleString('zh-CN') : '-'}</td>
                            <td>
                                ${canEdit ? 
                                    `<button class="btn btn-primary btn-sm" onclick="editAdmin(${user.admin_id})">ç¼–è¾‘</button>` : 
                                    '<span style="color: #999;">æ— æƒé™</span>'
                                }
                                ${canDelete ? 
                                    `<button class="btn btn-danger btn-sm" onclick="showDeleteUserModal('admin', ${user.admin_id}, '${user.username}')">åˆ é™¤</button>` : 
                                    ''
                                }
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else if (type === 'all') {
                    thead.innerHTML = `
                        <tr>
                            <th>ç”¨æˆ·ID</th>
                            <th>ç”¨æˆ·ç±»å‹</th>
                            <th>ç”¨æˆ·å</th>
                            <th>å§“å</th>
                            <th>å…¶ä»–ä¿¡æ¯</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    `;
                    
                    users.forEach(user => {
                        const row = document.createElement('tr');
                        let userId, userTypeText, name, otherInfo, actionBtns;
                        
                        if (user.userType === 'patient') {
                            userId = user.patient_id;
                            userTypeText = '<span class="status-badge" style="background-color: #e3f2fd; color: #1976d2;">æ‚£è€…</span>';
                            name = user.name;
                            otherInfo = `${user.phone || 'æœªæä¾›'} / ${user.gender || 'æœªè®¾ç½®'}`;
                            actionBtns = `
                                <button class="btn btn-warning btn-sm" onclick='showEditPatientModal(${JSON.stringify(user)})'>ç¼–è¾‘</button>
                                <button class="btn btn-danger btn-sm" onclick="showDeleteUserModal('patient', ${user.patient_id}, '${user.name}')">åˆ é™¤</button>
                            `;
                        } else if (user.userType === 'doctor') {
                            userId = user.doctor_id;
                            userTypeText = '<span class="status-badge" style="background-color: #e8f5e8; color: #2e7d32;">åŒ»ç”Ÿ</span>';
                            name = user.name;
                            otherInfo = `${user.title || 'æœªè®¾ç½®'} / ${user.dept_name || 'æœªçŸ¥ç§‘å®¤'}`;
                            actionBtns = `
                                <button class="btn btn-warning btn-sm" onclick='showEditDoctorModal(${JSON.stringify(user)})'>ç¼–è¾‘</button>
                                <button class="btn btn-danger btn-sm" onclick="showDeleteUserModal('doctor', ${user.doctor_id}, '${user.name}')">åˆ é™¤</button>
                            `;
                        } else if (user.userType === 'admin') {
                            userId = user.admin_id;
                            userTypeText = '<span class="status-badge" style="background-color: #fff3cd; color: #856404;">ç®¡ç†å‘˜</span>';
                            name = '-';
                            otherInfo = '-';
                            const currentUserId = parseInt(localStorage.getItem('user_id'));
                            const canDelete = user.admin_id > currentUserId;
                            actionBtns = canDelete ? 
                                `<button class="btn btn-danger btn-sm" onclick="showDeleteUserModal('admin', ${user.admin_id}, '${user.username}')">åˆ é™¤</button>` : 
                                '<span style="color: #999;">ä¸å¯åˆ é™¤</span>';
                        }
                        
                        row.innerHTML = `
                            <td>${userId}</td>
                            <td>${userTypeText}</td>
                            <td>${user.username}</td>
                            <td>${name}</td>
                            <td>${otherInfo}</td>
                            <td>${actionBtns}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                container.style.display = 'block';
            } catch (error) {
                showMessage('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥: ' + error.message, 'danger');
            } finally {
                loading.style.display = 'none';
            }
        }

        async function loadRegistrations() {
            const loading = document.getElementById('registrationsLoading');
            const container = document.getElementById('registrationsContainer');
            
            loading.style.display = 'flex';
            container.style.display = 'none';

            try {
                const registrations = await apiRequest('/admin/registrations');
                const tbody = document.getElementById('registrationsTable');
                
                tbody.innerHTML = '';

                // Sort by creation time (newest first)
                registrations.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                registrations.forEach(reg => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${reg.reg_id}</td>
                        <td>${reg.patient_name}</td>
                        <td>${reg.doctor_name}</td>
                        <td>${reg.dept_name}</td>
                        <td>${formatDateTime(reg.reg_time)}</td>
                        <td><span class="status-badge status-${reg.status}">${getStatusText(reg.status)}</span></td>
                        <td>${formatDateTime(reg.created_at)}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick='showEditRegistrationModal(${JSON.stringify(reg)})'>ç¼–è¾‘</button>
                            <button class="btn btn-danger btn-sm" onclick="showDeleteRegistrationModal(${reg.reg_id})">åˆ é™¤</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                container.style.display = 'block';
            } catch (error) {
                showMessage('åŠ è½½æŒ‚å·è®°å½•å¤±è´¥: ' + error.message, 'danger');
            } finally {
                loading.style.display = 'none';
            }
        }

        function showUserType(type) {
            loadUsers(type);
        }

        // Department management functions
        function showAddDepartmentModal() {
            document.getElementById('addDepartmentModal').style.display = 'block';
        }

        function closeAddDepartmentModal() {
            document.getElementById('addDepartmentModal').style.display = 'none';
            document.getElementById('addDepartmentForm').reset();
        }

        async function handleAddDepartment(e) {
            e.preventDefault();
            
            const deptName = document.getElementById('deptName').value;
            const deptLocation = document.getElementById('deptLocation').value;

            try {
                await apiRequest('/admin/department', {
                    method: 'POST',
                    body: JSON.stringify({
                        dept_name: deptName,
                        location: deptLocation
                    })
                });

                showMessage('ç§‘å®¤æ·»åŠ æˆåŠŸ', 'success');
                closeAddDepartmentModal();
                loadDepartments();
                loadStats();
            } catch (error) {
                showMessage('æ·»åŠ ç§‘å®¤å¤±è´¥: ' + error.message, 'danger');
            }
        }

        function showEditDepartmentModal(deptId, deptName, location) {
            currentEditDeptId = deptId;
            document.getElementById('editDeptName').value = deptName;
            document.getElementById('editDeptLocation').value = location;
            document.getElementById('editDepartmentModal').style.display = 'block';
        }

        function closeEditDepartmentModal() {
            document.getElementById('editDepartmentModal').style.display = 'none';
            document.getElementById('editDepartmentForm').reset();
            currentEditDeptId = null;
        }

        async function handleEditDepartment(e) {
            e.preventDefault();
            
            if (!currentEditDeptId) return;

            const deptName = document.getElementById('editDeptName').value;
            const deptLocation = document.getElementById('editDeptLocation').value;

            try {
                await apiRequest(`/admin/department/${currentEditDeptId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        dept_name: deptName,
                        location: deptLocation
                    })
                });

                showMessage('ç§‘å®¤æ›´æ–°æˆåŠŸ', 'success');
                closeEditDepartmentModal();
                loadDepartments();
            } catch (error) {
                showMessage('æ›´æ–°ç§‘å®¤å¤±è´¥: ' + error.message, 'danger');
            }
        }

        function showDeleteDepartmentModal(deptId, deptName, doctorCount) {
            if (doctorCount > 0) {
                showMessage(`æ— æ³•åˆ é™¤ç§‘å®¤"${deptName}"ï¼Œè¯¥ç§‘å®¤è¿˜æœ‰${doctorCount}ååŒ»ç”Ÿ`, 'warning');
                return;
            }

            currentDeleteAction = {
                type: 'department',
                id: deptId,
                name: deptName
            };

            document.getElementById('deleteMessage').textContent = `ç¡®å®šè¦åˆ é™¤ç§‘å®¤"${deptName}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`;
            document.getElementById('confirmDeleteModal').style.display = 'block';
        }

        function showDeleteUserModal(role, userId, userName) {
            currentDeleteAction = {
                type: 'user',
                role: role,
                id: userId,
                name: userName
            };

            const roleText = role === 'patient' ? 'æ‚£è€…' : 'åŒ»ç”Ÿ';
            document.getElementById('deleteMessage').textContent = `ç¡®å®šè¦åˆ é™¤${roleText}"${userName}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`;
            document.getElementById('confirmDeleteModal').style.display = 'block';
        }

        function closeConfirmDeleteModal() {
            document.getElementById('confirmDeleteModal').style.display = 'none';
            currentDeleteAction = null;
        }

        async function confirmDelete() {
            if (!currentDeleteAction) return;

            try {
                if (currentDeleteAction.type === 'department') {
                    await apiRequest(`/admin/department/${currentDeleteAction.id}`, {
                        method: 'DELETE'
                    });
                    showMessage('ç§‘å®¤åˆ é™¤æˆåŠŸ', 'success');
                    loadDepartments();
                } else if (currentDeleteAction.type === 'user') {
                    await apiRequest(`/admin/users/${currentDeleteAction.role}/${currentDeleteAction.id}`, {
                        method: 'DELETE'
                    });
                    showMessage('ç”¨æˆ·åˆ é™¤æˆåŠŸ', 'success');
                    loadUsers(currentUserType);
                } else if (currentDeleteAction.type === 'registration') {
                    await apiRequest(`/admin/registrations/${currentDeleteAction.id}`, {
                        method: 'DELETE'
                    });
                    showMessage('æŒ‚å·è®°å½•åˆ é™¤æˆåŠŸ', 'success');
                    loadRegistrations();
                }
                
                loadStats();
                closeConfirmDeleteModal();
            } catch (error) {
                showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'danger');
            }
        }

        // Edit Patient Modal
        function showEditPatientModal(patient) {
            document.getElementById('editPatientId').value = patient.patient_id;
            document.getElementById('editPatientName').value = patient.name;
            document.getElementById('editPatientPhone').value = patient.phone || '';
            document.getElementById('editPatientGender').value = patient.gender || '';
            document.getElementById('editPatientBirthday').value = patient.birthday || '';
            document.getElementById('editPatientModal').style.display = 'block';
        }

        function closeEditPatientModal() {
            document.getElementById('editPatientModal').style.display = 'none';
            document.getElementById('editPatientForm').reset();
        }

        async function handleEditPatient(e) {
            e.preventDefault();
            
            const patientId = document.getElementById('editPatientId').value;
            const data = {
                name: document.getElementById('editPatientName').value,
                phone: document.getElementById('editPatientPhone').value,
                gender: document.getElementById('editPatientGender').value,
                birthday: document.getElementById('editPatientBirthday').value
            };

            try {
                await apiRequest(`/admin/patients/${patientId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });

                showMessage('æ‚£è€…ä¿¡æ¯æ›´æ–°æˆåŠŸ', 'success');
                closeEditPatientModal();
                loadUsers(currentUserType);
            } catch (error) {
                showMessage('æ›´æ–°å¤±è´¥: ' + error.message, 'danger');
            }
        }

        // Edit Doctor Modal
        async function showEditDoctorModal(doctor) {
            document.getElementById('editDoctorId').value = doctor.doctor_id;
            document.getElementById('editDoctorName').value = doctor.name;
            
            // Load titles for dropdown
            try {
                const titlesData = await apiRequest('/titles');
                const titleSelect = document.getElementById('editDoctorTitle');
                titleSelect.innerHTML = '<option value="">è¯·é€‰æ‹©èŒç§°</option>';
                
                if (titlesData.success && titlesData.titles) {
                    titlesData.titles.forEach(title => {
                        const option = document.createElement('option');
                        option.value = title.title_id;
                        option.textContent = title.title_name;
                        if (title.title_id === doctor.title_id) {
                            option.selected = true;
                        }
                        titleSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½èŒç§°å¤±è´¥:', error);
            }
            
            // Load departments for dropdown
            try {
                const departments = await apiRequest('/departments');
                const select = document.getElementById('editDoctorDept');
                select.innerHTML = '';
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.dept_id;
                    option.textContent = dept.dept_name;
                    if (dept.dept_id === doctor.dept_id) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            } catch (error) {
                showMessage('åŠ è½½ç§‘å®¤åˆ—è¡¨å¤±è´¥', 'danger');
            }
            
            document.getElementById('editDoctorModal').style.display = 'block';
        }

        function closeEditDoctorModal() {
            document.getElementById('editDoctorModal').style.display = 'none';
            document.getElementById('editDoctorForm').reset();
        }

        async function handleEditDoctor(e) {
            e.preventDefault();
            
            const doctorId = document.getElementById('editDoctorId').value;
            const data = {
                name: document.getElementById('editDoctorName').value,
                title_id: parseInt(document.getElementById('editDoctorTitle').value) || null,
                dept_id: parseInt(document.getElementById('editDoctorDept').value)
            };

            try {
                await apiRequest(`/admin/doctors/${doctorId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });

                showMessage('åŒ»ç”Ÿä¿¡æ¯æ›´æ–°æˆåŠŸ', 'success');
                closeEditDoctorModal();
                loadUsers(currentUserType);
            } catch (error) {
                showMessage('æ›´æ–°å¤±è´¥: ' + error.message, 'danger');
            }
        }

        // Edit Registration Modal
        function showEditRegistrationModal(registration) {
            document.getElementById('editRegId').value = registration.reg_id;
            document.getElementById('editRegPatient').value = registration.patient_name;
            document.getElementById('editRegDoctor').value = registration.doctor_name;
            
            // Convert datetime to local format
            const regTime = new Date(registration.reg_time);
            const localDateTime = new Date(regTime.getTime() - regTime.getTimezoneOffset() * 60000)
                .toISOString().slice(0, 16);
            document.getElementById('editRegTime').value = localDateTime;
            document.getElementById('editRegStatus').value = registration.status;
            
            document.getElementById('editRegistrationModal').style.display = 'block';
        }

        function closeEditRegistrationModal() {
            document.getElementById('editRegistrationModal').style.display = 'none';
            document.getElementById('editRegistrationForm').reset();
        }

        async function handleEditRegistration(e) {
            e.preventDefault();
            
            const regId = document.getElementById('editRegId').value;
            const regTime = document.getElementById('editRegTime').value;
            const status = document.getElementById('editRegStatus').value;

            try {
                await apiRequest(`/admin/registrations/${regId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        reg_time: regTime,
                        status: status
                    })
                });

                showMessage('æŒ‚å·è®°å½•æ›´æ–°æˆåŠŸ', 'success');
                closeEditRegistrationModal();
                loadRegistrations();
                loadStats();
            } catch (error) {
                showMessage('æ›´æ–°å¤±è´¥: ' + error.message, 'danger');
            }
        }

        // Delete Registration
        function showDeleteRegistrationModal(regId) {
            currentDeleteAction = {
                type: 'registration',
                id: regId
            };
            document.getElementById('deleteMessage').textContent = 'ç¡®å®šè¦åˆ é™¤è¿™æ¡æŒ‚å·è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚';
            document.getElementById('confirmDeleteModal').style.display = 'block';
        }

        function getStatusText(status) {
            const statusMap = {
                'registered': 'å·²æŒ‚å·',
                'completed': 'å·²å°±è¯Š',
                'cancelled': 'å·²è¿‡å·'
            };
            return statusMap[status] || status;
        }

        function formatDateTime(dateTimeStr) {
            const date = new Date(dateTimeStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // æ˜¾ç¤ºç§‘å®¤æŒ‚å·è¶‹åŠ¿
        async function showDeptRegistrations(deptName) {
            try {
                // è·å–è¯¥ç§‘å®¤ä¸€ä¸ªæœˆçš„æŒ‚å·è¶‹åŠ¿æ•°æ®
                const trendData = await apiRequest(`/admin/department-trend?dept_name=${encodeURIComponent(deptName)}`);
                
                // æ›´æ–°æŠ˜çº¿å›¾
                if (timeChart) {
                    timeChart.data.labels = trendData.labels;
                    timeChart.data.datasets[0].data = trendData.data;
                    timeChart.data.datasets[0].label = `${deptName} - æŒ‚å·æ•°é‡`;
                    timeChart.options.plugins.title = {
                        display: true,
                        text: `${deptName} - è¿‘30å¤©æŒ‚å·è¶‹åŠ¿`,
                        font: { size: 14, weight: 'bold' },
                        padding: { bottom: 10 }
                    };
                    timeChart.update();
                }
                
                showMessage(`å·²åˆ‡æ¢åˆ° ${deptName} çš„æŒ‚å·è¶‹åŠ¿`, 'info');
            } catch (error) {
                showMessage('åŠ è½½ç§‘å®¤è¶‹åŠ¿å¤±è´¥: ' + error.message, 'danger');
            }
        }

        // é‡ç½®ä¸ºå…¨éƒ¨ç§‘å®¤è¶‹åŠ¿
        async function resetTimeChart() {
            try {
                const chartData = await apiRequest('/admin/chart-data');
                
                if (timeChart) {
                    timeChart.data.labels = chartData.time.labels;
                    timeChart.data.datasets[0].data = chartData.time.data;
                    timeChart.data.datasets[0].label = 'æŒ‚å·æ•°é‡';
                    timeChart.options.plugins.title = {
                        display: false
                    };
                    timeChart.update();
                }
            } catch (error) {
                console.error('é‡ç½®å›¾è¡¨å¤±è´¥:', error);
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `alert alert-${type} message`;
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        // ç§»åŠ¨ç«¯èœå•æ§åˆ¶
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        // ç‚¹å‡»å¯¼èˆªé¡¹åè‡ªåŠ¨å…³é—­ç§»åŠ¨ç«¯èœå•
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    toggleSidebar();
                }
            });
        });

        // Admin management functions
        function showAddAdminModal() {
            document.getElementById('addAdminModal').style.display = 'block';
        }

        function closeAddAdminModal() {
            document.getElementById('addAdminModal').style.display = 'none';
            document.getElementById('addAdminForm').reset();
        }

        async function handleAddAdmin(e) {
            e.preventDefault();
            
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            const email = document.getElementById('adminEmail').value;

            try {
                await apiRequest('/admin/create_admin', {
                    method: 'POST',
                    body: JSON.stringify({
                        username: username,
                        password: password,
                        email: email || null
                    })
                });

                showMessage('ç®¡ç†å‘˜æ·»åŠ æˆåŠŸ', 'success');
                closeAddAdminModal();
                loadUsers('admins');
            } catch (error) {
                showMessage('æ·»åŠ ç®¡ç†å‘˜å¤±è´¥: ' + error.message, 'danger');
            }
        }

        // ç¼–è¾‘ç®¡ç†å‘˜ç›¸å…³å‡½æ•°
        async function editAdmin(adminId) {
            try {
                const response = await apiRequest('/admin/admins');
                const admins = response;
                const admin = admins.find(a => a.admin_id === adminId);
                
                if (!admin) {
                    showMessage('ç®¡ç†å‘˜ä¸å­˜åœ¨', 'danger');
                    return;
                }
                
                document.getElementById('editAdminId').value = admin.admin_id;
                document.getElementById('editAdminUsername').value = admin.username;
                document.getElementById('editAdminEmail').value = admin.email || '';
                document.getElementById('editAdminPassword').value = '';
                
                document.getElementById('editAdminModal').style.display = 'block';
            } catch (error) {
                showMessage('åŠ è½½ç®¡ç†å‘˜ä¿¡æ¯å¤±è´¥: ' + error.message, 'danger');
            }
        }

        function closeEditAdminModal() {
            document.getElementById('editAdminModal').style.display = 'none';
            document.getElementById('editAdminForm').reset();
        }

        async function handleEditAdmin(e) {
            e.preventDefault();
            
            const adminId = document.getElementById('editAdminId').value;
            const email = document.getElementById('editAdminEmail').value;
            const password = document.getElementById('editAdminPassword').value;
            
            const data = { email: email || null };
            if (password) {
                data.password = password;
            }
            
            try {
                await apiRequest(`/admin/admins/${adminId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                
                showMessage('ç®¡ç†å‘˜ä¿¡æ¯æ›´æ–°æˆåŠŸ', 'success');
                closeEditAdminModal();
                loadUsers('admins');
            } catch (error) {
                showMessage('æ›´æ–°å¤±è´¥: ' + error.message, 'danger');
            }
        }

        // Sidebar navigation function
        function showSection(sectionName) {
            // Hide all sections
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.classList.remove('active');
            });

            // Show selected section
            const selectedSection = document.getElementById(`section-${sectionName}`);
            if (selectedSection) {
                selectedSection.classList.add('active');
            }

            // Update navigation active state
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');

            // Update page title
            const titles = {
                'dashboard': 'ç³»ç»Ÿæ¦‚è§ˆ',
                'departments': 'ç§‘å®¤ç®¡ç†',
                'titles': 'èŒç§°ç®¡ç†',
                'users': 'ç”¨æˆ·ç®¡ç†',
                'registrations': 'æŒ‚å·è®°å½•',
                'schedule': 'æ’ç­ç®¡ç†',
                'database': 'æ•°æ®åº“ç®¡ç†'
            };
            document.getElementById('pageTitle').textContent = titles[sectionName] || 'ç®¡ç†å‘˜æ§åˆ¶å°';

            // Load data for the section if needed
            if (sectionName === 'dashboard') {
                loadStats();
            } else if (sectionName === 'departments') {
                loadDepartments();
            } else if (sectionName === 'titles') {
                loadTitles();
            } else if (sectionName === 'users') {
                // Load all users by default
                showUserType('all');
            } else if (sectionName === 'registrations') {
                loadRegistrations();
            } else if (sectionName === 'schedule') {
                loadScheduleList();
            } else if (sectionName === 'database') {
                initDatabaseManagement();
            }
        }

        // Search functions
        function searchDepartments() {
            const searchInput = document.getElementById('deptSearchInput').value.toLowerCase();
            const table = document.getElementById('departmentsTable');
            const rows = table.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                if (cells.length > 0) {
                    const deptName = cells[1].textContent.toLowerCase();
                    const location = cells[2].textContent.toLowerCase();
                    
                    if (deptName.includes(searchInput) || location.includes(searchInput)) {
                        rows[i].style.display = '';
                    } else {
                        rows[i].style.display = 'none';
                    }
                }
            }
        }
        
        function searchUsers() {
            const searchInput = document.getElementById('userSearchInput').value.toLowerCase();
            const table = document.getElementById('usersTable');
            const rows = table.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                if (cells.length > 0) {
                    let shouldShow = false;
                    
                    // Search in username and name columns
                    for (let j = 0; j < cells.length - 1; j++) { // Exclude last column (actions)
                        const cellText = cells[j].textContent.toLowerCase();
                        if (cellText.includes(searchInput)) {
                            shouldShow = true;
                            break;
                        }
                    }
                    
                    rows[i].style.display = shouldShow ? '' : 'none';
                }
            }
        }
        
        function searchRegistrations() {
            const patientSearch = document.getElementById('regPatientSearch').value.toLowerCase();
            const doctorSearch = document.getElementById('regDoctorSearch').value.toLowerCase();
            const statusFilter = document.getElementById('regStatusFilter').value;
            
            const table = document.getElementById('registrationsTable');
            const rows = table.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                if (cells.length > 0) {
                    const patientName = cells[1].textContent.toLowerCase();
                    const doctorName = cells[2].textContent.toLowerCase();
                    const status = cells[5].textContent;
                    
                    let matchPatient = patientSearch === '' || patientName.includes(patientSearch);
                    let matchDoctor = doctorSearch === '' || doctorName.includes(doctorSearch);
                    let matchStatus = statusFilter === '' || status.includes(getStatusText(statusFilter));
                    
                    if (matchPatient && matchDoctor && matchStatus) {
                        rows[i].style.display = '';
                    } else {
                        rows[i].style.display = 'none';
                    }
                }
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('role');
            localStorage.removeItem('username');
            localStorage.removeItem('user_id');
            window.location.href = 'login.html';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = [
                'addDepartmentModal', 
                'editDepartmentModal', 
                'confirmDeleteModal', 
                'addAdminModal',
                'editPatientModal',
                'editDoctorModal',
                'editRegistrationModal',
                'deptRegistrationsModal'
            ];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Schedule Management Functions
        let currentScheduleDoctorId = null;
        let allDoctorsForSchedule = [];

        async function loadScheduleList() {
            const loading = document.getElementById('scheduleLoading');
            const container = document.getElementById('scheduleContainer');
            
            loading.style.display = 'flex';
            container.style.display = 'none';

            try {
                const doctors = await apiRequest('/admin/doctors');
                allDoctorsForSchedule = doctors;
                
                // å¡«å……ç§‘å®¤ä¸‹æ‹‰æ¡†
                const deptSelect = document.getElementById('scheduleSearchDept');
                const departments = [...new Set(doctors.map(d => d.dept_name))].filter(Boolean);
                deptSelect.innerHTML = '<option value="">å…¨éƒ¨ç§‘å®¤</option>';
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    deptSelect.appendChild(option);
                });
                
                // æ˜¾ç¤ºæ‰€æœ‰åŒ»ç”Ÿ
                displayScheduleList(doctors);
                container.style.display = 'block';
            } catch (error) {
                showMessage('åŠ è½½æ’ç­åˆ—è¡¨å¤±è´¥: ' + error.message, 'danger');
            } finally {
                loading.style.display = 'none';
            }
        }

        function displayScheduleList(doctors) {
            const tbody = document.getElementById('scheduleTable');
            tbody.innerHTML = '';

            doctors.forEach(doctor => {
                const row = document.createElement('tr');
                const hasSchedule = doctor.schedule ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®';
                const scheduleClass = doctor.schedule ? 'status-completed' : 'status-cancelled';
                
                row.innerHTML = `
                    <td>${doctor.name}</td>
                    <td>${doctor.title || '-'}</td>
                    <td>${doctor.dept_name}</td>
                    <td><span class="status-badge ${scheduleClass}">${hasSchedule}</span></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="editSchedule(${doctor.doctor_id}, '${doctor.name}')">
                            ${doctor.schedule ? 'ç¼–è¾‘æ’ç­' : 'è®¾ç½®æ’ç­'}
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function searchSchedule() {
            const nameSearch = document.getElementById('scheduleSearchName').value.toLowerCase();
            const deptFilter = document.getElementById('scheduleSearchDept').value;
            const statusFilter = document.getElementById('scheduleSearchStatus').value;
            
            const filtered = allDoctorsForSchedule.filter(doctor => {
                const nameMatch = !nameSearch || doctor.name.toLowerCase().includes(nameSearch);
                const deptMatch = !deptFilter || doctor.dept_name === deptFilter;
                const statusMatch = !statusFilter || 
                    (statusFilter === 'set' && doctor.schedule) ||
                    (statusFilter === 'unset' && !doctor.schedule);
                
                return nameMatch && deptMatch && statusMatch;
            });
            
            displayScheduleList(filtered);
        }

        async function editSchedule(doctorId, doctorName) {
            currentScheduleDoctorId = doctorId;
            document.getElementById('scheduleDocName').textContent = `åŒ»ç”Ÿï¼š${doctorName}`;

            try {
                const data = await apiRequest(`/admin/doctors/${doctorId}/schedule`);
                const schedule = data.schedule || {};

                // é‡ç½®æ‰€æœ‰å¤é€‰æ¡†
                document.querySelectorAll('.schedule-checkbox').forEach(cb => {
                    cb.checked = false;
                });

                // è®¾ç½®å·²æœ‰çš„æ’ç­
                Object.keys(schedule).forEach(key => {
                    const checkbox = document.getElementById(key);
                    if (checkbox) {
                        checkbox.checked = schedule[key];
                    }
                });

                document.getElementById('editScheduleModal').style.display = 'block';
            } catch (error) {
                showMessage('åŠ è½½æ’ç­ä¿¡æ¯å¤±è´¥: ' + error.message, 'danger');
            }
        }

        async function saveSchedule() {
            const schedule = {};
            document.querySelectorAll('.schedule-checkbox').forEach(cb => {
                schedule[cb.id] = cb.checked;
            });

            try {
                await apiRequest(`/admin/doctors/${currentScheduleDoctorId}/schedule`, {
                    method: 'PUT',
                    body: JSON.stringify({ schedule })
                });

                showMessage('æ’ç­ä¿å­˜æˆåŠŸ', 'success');
                closeEditScheduleModal();
                loadScheduleList();
            } catch (error) {
                showMessage('ä¿å­˜æ’ç­å¤±è´¥: ' + error.message, 'danger');
            }
        }

        function closeEditScheduleModal() {
            document.getElementById('editScheduleModal').style.display = 'none';
            currentScheduleDoctorId = null;
        }

        // ==================== èŒç§°ç®¡ç†åŠŸèƒ½ ====================
        
        // åŠ è½½èŒç§°åˆ—è¡¨
        async function loadTitles() {
            document.getElementById('titlesLoading').style.display = 'block';
            document.getElementById('titlesContainer').style.display = 'none';
            
            try {
                const data = await apiRequest('/titles');
                
                if (data.success) {
                    displayTitles(data.titles);
                } else {
                    showMessage('è·å–èŒç§°åˆ—è¡¨å¤±è´¥: ' + data.message, 'danger');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
            } finally {
                document.getElementById('titlesLoading').style.display = 'none';
                document.getElementById('titlesContainer').style.display = 'block';
            }
        }

        // æ˜¾ç¤ºèŒç§°åˆ—è¡¨
        function displayTitles(titles) {
            const tbody = document.getElementById('titlesTable');
            tbody.innerHTML = '';
            
            titles.forEach(title => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${title.title_id}</td>
                    <td>${title.title_name}</td>
                    <td>Â¥${title.registration_fee}</td>
                    <td>${title.doctor_count}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editTitle(${title.title_id}, '${title.title_name}', ${title.registration_fee})">ç¼–è¾‘</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTitle(${title.title_id}, '${title.title_name}', ${title.doctor_count})" 
                                ${title.doctor_count > 0 ? 'disabled title="è¿˜æœ‰åŒ»ç”Ÿä½¿ç”¨è¯¥èŒç§°"' : ''}>åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // æœç´¢èŒç§°
        function searchTitles() {
            const searchTerm = document.getElementById('titleSearchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#titlesTable tr');
            
            rows.forEach(row => {
                const titleName = row.cells[1].textContent.toLowerCase();
                if (titleName.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // æ˜¾ç¤ºæ·»åŠ èŒç§°æ¨¡æ€æ¡†
        function showAddTitleModal() {
            document.getElementById('addTitleModal').style.display = 'block';
            document.getElementById('titleName').value = '';
            document.getElementById('registrationFee').value = '';
        }

        // å…³é—­æ·»åŠ èŒç§°æ¨¡æ€æ¡†
        function closeAddTitleModal() {
            document.getElementById('addTitleModal').style.display = 'none';
        }

        // ç¼–è¾‘èŒç§°
        function editTitle(titleId, titleName, registrationFee) {
            document.getElementById('editTitleId').value = titleId;
            document.getElementById('editTitleName').value = titleName;
            document.getElementById('editRegistrationFee').value = registrationFee;
            document.getElementById('editTitleModal').style.display = 'block';
        }

        // å…³é—­ç¼–è¾‘èŒç§°æ¨¡æ€æ¡†
        function closeEditTitleModal() {
            document.getElementById('editTitleModal').style.display = 'none';
        }

        // åˆ é™¤èŒç§°
        async function deleteTitle(titleId, titleName, doctorCount) {
            if (doctorCount > 0) {
                showMessage(`æ— æ³•åˆ é™¤èŒç§°"${titleName}"ï¼Œè¿˜æœ‰ ${doctorCount} ååŒ»ç”Ÿä½¿ç”¨è¯¥èŒç§°`, 'danger');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤èŒç§°"${titleName}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                try {
                    const data = await apiRequest(`/titles/${titleId}`, {
                        method: 'DELETE'
                    });
                    
                    if (data.success) {
                        showMessage(data.message, 'success');
                        loadTitles();
                    } else {
                        showMessage(data.message, 'danger');
                    }
                } catch (error) {
                    showMessage('åˆ é™¤èŒç§°å¤±è´¥: ' + error.message, 'danger');
                }
            }
        }

        // æ·»åŠ èŒç§°è¡¨å•æäº¤
        document.getElementById('addTitleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const titleName = document.getElementById('titleName').value.trim();
            const registrationFee = document.getElementById('registrationFee').value;
            
            if (!titleName) {
                showMessage('è¯·è¾“å…¥èŒç§°åç§°', 'danger');
                return;
            }
            
            if (!registrationFee || parseFloat(registrationFee) < 0) {
                showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„æŒ‚å·è´¹', 'danger');
                return;
            }
            
            try {
                const data = await apiRequest('/titles', {
                    method: 'POST',
                    body: JSON.stringify({
                        title_name: titleName,
                        registration_fee: parseFloat(registrationFee)
                    })
                });
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    closeAddTitleModal();
                    loadTitles();
                } else {
                    showMessage(data.message, 'danger');
                }
            } catch (error) {
                showMessage('æ·»åŠ èŒç§°å¤±è´¥: ' + error.message, 'danger');
            }
        });

        // ç¼–è¾‘èŒç§°è¡¨å•æäº¤
        document.getElementById('editTitleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const titleId = document.getElementById('editTitleId').value;
            const titleName = document.getElementById('editTitleName').value.trim();
            const registrationFee = document.getElementById('editRegistrationFee').value;
            
            if (!titleName) {
                showMessage('è¯·è¾“å…¥èŒç§°åç§°', 'danger');
                return;
            }
            
            if (!registrationFee || parseFloat(registrationFee) < 0) {
                showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„æŒ‚å·è´¹', 'danger');
                return;
            }
            
            try {
                const data = await apiRequest(`/titles/${titleId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        title_name: titleName,
                        registration_fee: parseFloat(registrationFee)
                    })
                });
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    closeEditTitleModal();
                    loadTitles();
                } else {
                    showMessage(data.message, 'danger');
                }
            } catch (error) {
                showMessage('æ›´æ–°èŒç§°å¤±è´¥: ' + error.message, 'danger');
            }
        });

        // ==================== æ•°æ®åº“ç®¡ç†åŠŸèƒ½ ====================
        let currentDatabase = 'sqlite';
        let currentTable = '';
        let currentPage = 1;
        let currentEditRecord = null;
        let currentConflict = null;

        // åˆå§‹åŒ–æ•°æ®åº“ç®¡ç†
        async function initDatabaseManagement() {
            try {
                const response = await apiRequest('/admin/database/tables');
                if (response.success) {
                    const tables = response.tables[currentDatabase] || [];
                    const select = document.getElementById('dbTableSelect');
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©è¡¨æ ¼</option>';
                    tables.forEach(table => {
                        const option = document.createElement('option');
                        option.value = table;
                        option.textContent = table;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                showMessage('åŠ è½½è¡¨åˆ—è¡¨å¤±è´¥: ' + error.message, 'danger');
            }
        }

        // é€‰æ‹©æ•°æ®åº“
        async function selectDatabase(dbName) {
            currentDatabase = dbName;
            currentTable = '';
            currentPage = 1;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.db-selector .btn').forEach(btn => {
                btn.classList.remove('btn-primary', 'active');
                btn.classList.add('btn-secondary');
            });
            const selectedBtn = document.getElementById(`btn-db-${dbName}`);
            selectedBtn.classList.remove('btn-secondary');
            selectedBtn.classList.add('btn-primary', 'active');
            
            // æ›´æ–°å½“å‰æ•°æ®åº“æ˜¾ç¤º
            const dbNames = {
                'sqlite': 'SQLite (ä¸»åº“)',
                'mysql': 'MySQL (ä»åº“)',
                'sqlserver': 'SQL Server (ä»åº“)'
            };
            document.getElementById('currentDatabase').textContent = dbNames[dbName];
            
            // é‡æ–°åŠ è½½è¡¨åˆ—è¡¨
            await initDatabaseManagement();
            
            // éšè—è¡¨æ ¼
            document.getElementById('dbTableContainer').style.display = 'none';
        }

        // åŠ è½½è¡¨æ•°æ®
        async function loadTableData(page = 1) {
            const tableName = document.getElementById('dbTableSelect').value;
            if (!tableName) {
                showMessage('è¯·å…ˆé€‰æ‹©è¡¨æ ¼', 'warning');
                return;
            }
            
            currentTable = tableName;
            currentPage = page;
            
            document.getElementById('dbLoading').style.display = 'block';
            document.getElementById('dbTableContainer').style.display = 'none';
            document.getElementById('conflictContainer').style.display = 'none';
            
            try {
                const response = await apiRequest('/admin/database/table-data', {
                    method: 'POST',
                    body: JSON.stringify({
                        database: currentDatabase,
                        table: tableName,
                        page: page,
                        page_size: 20
                    })
                });
                
                if (response.success) {
                    displayTableData(response.data);
                } else {
                    showMessage('åŠ è½½æ•°æ®å¤±è´¥: ' + response.error, 'danger');
                }
            } catch (error) {
                showMessage('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message, 'danger');
            } finally {
                document.getElementById('dbLoading').style.display = 'none';
            }
        }

        // æ˜¾ç¤ºè¡¨æ•°æ®
        function displayTableData(data) {
            document.getElementById('currentTable').textContent = currentTable;
            document.getElementById('totalRecords').textContent = data.total;
            
            // å®šä¹‰éœ€è¦éšè—çš„å­—æ®µ
            const hiddenFields = ['password_hash', 'password', 'passwordhash'];
            
            // å®šä¹‰å­—æ®µæ˜¾ç¤ºä¼˜å…ˆçº§å’Œå®½åº¦
            const fieldConfig = {
                // ä¸»è¦å­—æ®µ - æ€»æ˜¯æ˜¾ç¤º
                'admin_id': { priority: 1, width: '60px', label: 'ID' },
                'patient_id': { priority: 1, width: '60px', label: 'ID' },
                'doctor_id': { priority: 1, width: '60px', label: 'ID' },
                'dept_id': { priority: 1, width: '60px', label: 'ID' },
                'reg_id': { priority: 1, width: '60px', label: 'ID' },
                'title_id': { priority: 1, width: '60px', label: 'ID' },
                
                // é‡è¦å­—æ®µ
                'username': { priority: 2, width: '100px', label: 'ç”¨æˆ·å' },
                'name': { priority: 2, width: '80px', label: 'å§“å' },
                'dept_name': { priority: 2, width: '120px', label: 'ç§‘å®¤å' },
                'title_name': { priority: 2, width: '100px', label: 'èŒç§°' },
                'email': { priority: 2, width: '150px', label: 'é‚®ç®±' },
                'phone': { priority: 2, width: '110px', label: 'ç”µè¯' },
                'status': { priority: 2, width: '80px', label: 'çŠ¶æ€' },
                
                // æ¬¡è¦å­—æ®µ
                'gender': { priority: 3, width: '60px', label: 'æ€§åˆ«' },
                'birthday': { priority: 3, width: '100px', label: 'ç”Ÿæ—¥' },
                'location': { priority: 3, width: '120px', label: 'ä½ç½®' },
                'registration_fee': { priority: 3, width: '80px', label: 'è´¹ç”¨' },
                'fee': { priority: 3, width: '80px', label: 'è´¹ç”¨' },
                'reg_time': { priority: 3, width: '140px', label: 'æŒ‚å·æ—¶é—´' },
                
                // æ—¶é—´æˆ³å­—æ®µ - ç®€åŒ–æ˜¾ç¤º
                'created_at': { priority: 4, width: '110px', label: 'åˆ›å»ºæ—¶é—´' },
                'updated_at': { priority: 4, width: '110px', label: 'æ›´æ–°æ—¶é—´' },
                
                // å…¶ä»–å­—æ®µ
                'schedule': { priority: 5, width: '150px', label: 'æ’ç­' },
                'photo': { priority: 5, width: '100px', label: 'ç…§ç‰‡' }
            };
            
            // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
            const isMobile = window.innerWidth <= 768;
            
            // è¿‡æ»¤å’Œæ’åºåˆ—
            let visibleColumns = data.columns
                .filter(col => !hiddenFields.some(hidden => col.toLowerCase() === hidden.toLowerCase()))
                .sort((a, b) => {
                    const priorityA = fieldConfig[a]?.priority || 6;
                    const priorityB = fieldConfig[b]?.priority || 6;
                    return priorityA - priorityB;
                });
            
            // ç§»åŠ¨ç«¯åªæ˜¾ç¤ºæœ€é‡è¦çš„åˆ—
            if (isMobile) {
                visibleColumns = visibleColumns.filter(col => {
                    const config = fieldConfig[col];
                    return !config || config.priority <= 3; // åªæ˜¾ç¤ºä¼˜å…ˆçº§1-3çš„å­—æ®µ
                });
            }
            
            // æ„å»ºè¡¨å¤´
            const thead = document.getElementById('dataTableHead');
            thead.innerHTML = '';
            const headerRow = document.createElement('tr');
            
            visibleColumns.forEach(col => {
                const th = document.createElement('th');
                const config = fieldConfig[col];
                
                // è®¾ç½®åˆ—æ ‡é¢˜
                th.textContent = config?.label || col;
                
                // è®¾ç½®åˆ—å®½
                if (config?.width) {
                    th.style.width = config.width;
                    th.style.minWidth = config.width;
                }
                
                // ä¸»é”®æ ‡è¯†
                if (data.primary_keys.includes(col)) {
                    th.innerHTML += ' <span style="color: #f39c12;">ğŸ”‘</span>';
                }
                
                // æ ·å¼ä¼˜åŒ–
                th.style.fontSize = '12px';
                th.style.padding = '8px 8px';
                th.style.whiteSpace = 'nowrap';
                th.style.fontWeight = 'bold';
                th.style.backgroundColor = '#f8f9fa';
                
                // æ ¹æ®å­—æ®µç±»å‹è®¾ç½®è¡¨å¤´å¯¹é½æ–¹å¼
                if (col.includes('id') || col.includes('fee') || col === 'registration_fee') {
                    th.style.textAlign = 'center';
                } else if (col.includes('time') || col.includes('_at')) {
                    th.style.textAlign = 'center';
                } else if (col === 'name' || col === 'username' || col === 'title_name' || col === 'dept_name') {
                    th.style.textAlign = 'center';
                } else {
                    th.style.textAlign = 'center';
                }
                
                headerRow.appendChild(th);
            });
            
            // æ“ä½œåˆ—
            const actionTh = document.createElement('th');
            actionTh.textContent = 'æ“ä½œ';
            if (isMobile) {
                actionTh.style.width = '60px';
                actionTh.style.minWidth = '60px';
                actionTh.style.maxWidth = '60px';
            } else {
                actionTh.style.width = '120px';
                actionTh.style.minWidth = '120px';
            }
            actionTh.style.fontSize = '12px';
            actionTh.style.padding = '8px 4px';
            actionTh.style.textAlign = 'center';
            headerRow.appendChild(actionTh);
            
            thead.appendChild(headerRow);
            
            // æ„å»ºè¡¨ä½“
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            data.rows.forEach(row => {
                const tr = document.createElement('tr');
                
                visibleColumns.forEach(col => {
                    const td = document.createElement('td');
                    const config = fieldConfig[col];
                    
                    // å¤„ç†æ•°æ®æ˜¾ç¤º
                    let displayValue = row[col];
                    
                    if (displayValue === null) {
                        displayValue = 'NULL';
                        td.style.color = '#999';
                        td.style.fontStyle = 'italic';
                    } else {
                        // ç‰¹æ®Šå­—æ®µå¤„ç†
                        if (col.includes('time') || col.includes('_at')) {
                            // æ—¶é—´å­—æ®µç®€åŒ–æ˜¾ç¤º
                            if (displayValue && displayValue.length > 16) {
                                displayValue = displayValue.substring(0, 16);
                            }
                        } else if (col === 'schedule' && displayValue && displayValue.length > 20) {
                            // æ’ç­ä¿¡æ¯æˆªæ–­
                            displayValue = displayValue.substring(0, 20) + '...';
                        } else if (col === 'photo' && displayValue) {
                            // ç…§ç‰‡å­—æ®µæ˜¾ç¤ºæ–‡ä»¶å
                            displayValue = displayValue.split('/').pop() || displayValue;
                            if (displayValue.length > 15) {
                                displayValue = displayValue.substring(0, 15) + '...';
                            }
                        }
                    }
                    
                    td.textContent = displayValue;
                    
                    // æ ·å¼è®¾ç½®
                    td.style.fontSize = '11px';
                    td.style.padding = '6px 8px';
                    
                    // æ ¹æ®å­—æ®µç±»å‹è®¾ç½®å¯¹é½æ–¹å¼
                    if (col.includes('id') || col.includes('fee') || col === 'registration_fee') {
                        td.style.textAlign = 'center';
                    } else if (col.includes('time') || col.includes('_at')) {
                        td.style.textAlign = 'center';
                    } else if (col === 'name' || col === 'username' || col === 'title_name' || col === 'dept_name') {
                        td.style.textAlign = 'center';
                    } else {
                        td.style.textAlign = 'left';
                    }
                    
                    td.style.whiteSpace = 'nowrap';
                    td.style.overflow = 'hidden';
                    td.style.textOverflow = 'ellipsis';
                    td.style.verticalAlign = 'middle';
                    
                    if (config?.width) {
                        td.style.maxWidth = config.width;
                    }
                    
                    tr.appendChild(td);
                });
                
                // æ“ä½œæŒ‰é’®
                const actionTd = document.createElement('td');
                actionTd.style.padding = '4px 2px';
                actionTd.style.textAlign = 'center';
                actionTd.style.whiteSpace = 'nowrap';
                
                if (isMobile) {
                    // ç§»åŠ¨ç«¯ä½¿ç”¨å‚ç›´æ’åˆ—çš„å°æŒ‰é’®
                    actionTd.style.padding = '2px';
                    actionTd.style.minWidth = '60px';
                    actionTd.style.maxWidth = '60px';
                    
                    const buttonContainer = document.createElement('div');
                    buttonContainer.style.display = 'flex';
                    buttonContainer.style.flexDirection = 'column';
                    buttonContainer.style.gap = '1px';
                    buttonContainer.style.alignItems = 'center';
                    
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-sm btn-primary';
                    editBtn.innerHTML = 'âœï¸';
                    editBtn.title = 'ç¼–è¾‘';
                    editBtn.style.fontSize = '10px';
                    editBtn.style.padding = '2px 4px';
                    editBtn.style.width = '28px';
                    editBtn.style.height = '24px';
                    editBtn.style.margin = '0';
                    editBtn.onclick = () => editRecord(row, data.columns, data.primary_keys);
                    
                    const compareBtn = document.createElement('button');
                    compareBtn.className = 'btn btn-sm btn-info';
                    compareBtn.innerHTML = 'ğŸ”';
                    compareBtn.title = 'å¯¹æ¯”';
                    compareBtn.style.fontSize = '10px';
                    compareBtn.style.padding = '2px 4px';
                    compareBtn.style.width = '28px';
                    compareBtn.style.height = '24px';
                    compareBtn.style.margin = '0';
                    compareBtn.onclick = () => compareRecord(row, data.primary_keys);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-sm btn-danger';
                    deleteBtn.innerHTML = 'ğŸ—‘ï¸';
                    deleteBtn.title = 'åˆ é™¤';
                    deleteBtn.style.fontSize = '10px';
                    deleteBtn.style.padding = '2px 4px';
                    deleteBtn.style.width = '28px';
                    deleteBtn.style.height = '24px';
                    deleteBtn.style.margin = '0';
                    deleteBtn.onclick = () => deleteRecord(row, data.primary_keys);
                    
                    buttonContainer.appendChild(editBtn);
                    buttonContainer.appendChild(compareBtn);
                    buttonContainer.appendChild(deleteBtn);
                    actionTd.appendChild(buttonContainer);
                } else {
                    // æ¡Œé¢ç«¯ä½¿ç”¨æ–‡å­—æŒ‰é’®
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-sm btn-primary';
                    editBtn.textContent = 'ç¼–è¾‘';
                    editBtn.style.fontSize = '10px';
                    editBtn.style.padding = '2px 6px';
                    editBtn.style.marginRight = '2px';
                    editBtn.onclick = () => editRecord(row, data.columns, data.primary_keys);
                    
                    const compareBtn = document.createElement('button');
                    compareBtn.className = 'btn btn-sm btn-info';
                    compareBtn.textContent = 'å¯¹æ¯”';
                    compareBtn.style.fontSize = '10px';
                    compareBtn.style.padding = '2px 6px';
                    compareBtn.style.marginRight = '2px';
                    compareBtn.onclick = () => compareRecord(row, data.primary_keys);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-sm btn-danger';
                    deleteBtn.textContent = 'åˆ é™¤';
                    deleteBtn.style.fontSize = '10px';
                    deleteBtn.style.padding = '2px 6px';
                    deleteBtn.onclick = () => deleteRecord(row, data.primary_keys);
                    
                    actionTd.appendChild(editBtn);
                    actionTd.appendChild(compareBtn);
                    actionTd.appendChild(deleteBtn);
                }
                
                tr.appendChild(actionTd);
                
                tbody.appendChild(tr);
            });
            
            // æ˜¾ç¤ºåˆ†é¡µ
            displayPagination(data);
            
            document.getElementById('dbTableContainer').style.display = 'block';
        }

        // æ˜¾ç¤ºåˆ†é¡µ
        function displayPagination(data) {
            const pagination = document.getElementById('dbPagination');
            pagination.innerHTML = '';
            
            if (data.total_pages <= 1) return;
            
            const createPageBtn = (page, text, disabled = false) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-sm ' + (page === data.page ? 'btn-primary' : 'btn-secondary');
                btn.textContent = text || page;
                btn.disabled = disabled;
                btn.onclick = () => loadTableData(page);
                return btn;
            };
            
            // ä¸Šä¸€é¡µ
            pagination.appendChild(createPageBtn(data.page - 1, 'ä¸Šä¸€é¡µ', data.page === 1));
            
            // é¡µç 
            for (let i = 1; i <= data.total_pages; i++) {
                if (i === 1 || i === data.total_pages || (i >= data.page - 2 && i <= data.page + 2)) {
                    pagination.appendChild(createPageBtn(i));
                } else if (i === data.page - 3 || i === data.page + 3) {
                    const span = document.createElement('span');
                    span.textContent = '...';
                    span.style.padding = '0 10px';
                    pagination.appendChild(span);
                }
            }
            
            // ä¸‹ä¸€é¡µ
            pagination.appendChild(createPageBtn(data.page + 1, 'ä¸‹ä¸€é¡µ', data.page === data.total_pages));
        }

        // ç¼–è¾‘è®°å½•
        function editRecord(row, columns, primaryKeys) {
            currentEditRecord = { row, columns, primaryKeys };
            
            const form = document.getElementById('editDataForm');
            form.innerHTML = '';
            
            columns.forEach(col => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                
                const label = document.createElement('label');
                label.textContent = col;
                if (primaryKeys.includes(col)) {
                    label.innerHTML += ' <span style="color: #f39c12;">ğŸ”‘ (ä¸»é”®)</span>';
                }
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-control';
                input.id = `edit-${col}`;
                input.value = row[col] !== null ? row[col] : '';
                
                // ä¸»é”®ä¸å¯ç¼–è¾‘
                if (primaryKeys.includes(col)) {
                    input.disabled = true;
                    input.style.backgroundColor = '#f5f5f5';
                }
                
                formGroup.appendChild(label);
                formGroup.appendChild(input);
                form.appendChild(formGroup);
            });
            
            document.getElementById('editDataModal').style.display = 'block';
        }

        // ä¿å­˜æ•°æ®æ›´æ”¹
        async function saveDataChanges() {
            if (!currentEditRecord) return;
            
            const { row, columns, primaryKeys } = currentEditRecord;
            
            // æ”¶é›†æ›´æ–°çš„æ•°æ®
            const updates = {};
            const primaryKey = {};
            
            columns.forEach(col => {
                const input = document.getElementById(`edit-${col}`);
                if (input && !input.disabled) {
                    const newValue = input.value.trim();
                    if (newValue !== (row[col] || '')) {
                        updates[col] = newValue || null;
                    }
                }
                if (primaryKeys.includes(col)) {
                    primaryKey[col] = row[col];
                }
            });
            
            if (Object.keys(updates).length === 0) {
                showMessage('æ²¡æœ‰ä¿®æ”¹ä»»ä½•æ•°æ®', 'warning');
                return;
            }
            
            try {
                const response = await apiRequest('/admin/database/update-record', {
                    method: 'POST',
                    body: JSON.stringify({
                        database: currentDatabase,
                        table: currentTable,
                        primary_key: primaryKey,
                        updates: updates
                    })
                });
                
                if (response.success) {
                    showMessage('æ•°æ®æ›´æ–°æˆåŠŸ', 'success');
                    closeEditDataModal();
                    loadTableData(currentPage);
                } else {
                    showMessage('æ›´æ–°å¤±è´¥: ' + response.error, 'danger');
                }
            } catch (error) {
                showMessage('æ›´æ–°å¤±è´¥: ' + error.message, 'danger');
            }
        }

        // å¯¹æ¯”è®°å½•
        async function compareRecord(row, primaryKeys) {
            const primaryKey = {};
            primaryKeys.forEach(col => {
                primaryKey[col] = row[col];
            });
            
            // æ ¹æ®è¡¨åç¡®å®šä¸»é”®å­—æ®µ
            const pkFieldMap = {
                'admin': 'admin_id',
                'patient': 'patient_id', 
                'doctor': 'doctor_id',
                'department': 'dept_id',
                'registration': 'reg_id',
                'title': 'title_id'
            };
            const pkField = pkFieldMap[currentTable] || Object.keys(primaryKey)[0];
            const recordId = primaryKey[pkField];
            
            try {
                const response = await apiRequest('/admin/database/compare-records', {
                    method: 'POST',
                    body: JSON.stringify({
                        table: currentTable,
                        record_id: recordId
                    })
                });
                
                if (response.success) {
                    displayComparisonResult(response, currentTable, recordId);
                } else {
                    showMessage('å¯¹æ¯”å¤±è´¥: ' + response.error, 'danger');
                }
            } catch (error) {
                showMessage('å¯¹æ¯”å¤±è´¥: ' + error.message, 'danger');
            }
        }

        // æ˜¾ç¤ºå¯¹æ¯”ç»“æœ
        function displayComparisonResult(result, tableName, recordId) {
            const details = document.getElementById('conflictDetails');
            details.innerHTML = '<h4>ä¸‰åº“æ•°æ®å¯¹æ¯”</h4>';
            
            const databases = ['sqlite', 'mysql', 'sqlserver'];
            databases.forEach(db => {
                const data = result.data[db];
                const section = document.createElement('div');
                section.style.marginBottom = '15px';
                section.style.padding = '10px';
                section.style.border = '1px solid #ddd';
                section.style.borderRadius = '4px';
                
                const title = document.createElement('h5');
                title.textContent = db.toUpperCase();
                title.style.color = db === 'sqlite' ? '#3498db' : '#95a5a6';
                section.appendChild(title);
                
                if (data && !data.error) {
                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.fontSize = '12px';
                    
                    // éœ€è¦éšè—çš„æ•æ„Ÿå­—æ®µ
                    const hiddenFields = ['password_hash', 'password', 'passwordhash'];
                    
                    for (const [key, value] of Object.entries(data)) {
                        // è·³è¿‡å¯†ç ç›¸å…³å­—æ®µ
                        if (hiddenFields.some(field => key.toLowerCase() === field.toLowerCase())) {
                            continue;
                        }
                        
                        const tr = document.createElement('tr');
                        const tdKey = document.createElement('td');
                        tdKey.textContent = key;
                        tdKey.style.fontWeight = 'bold';
                        tdKey.style.width = '30%';
                        
                        const tdValue = document.createElement('td');
                        tdValue.textContent = value !== null ? value : 'NULL';
                        
                        tr.appendChild(tdKey);
                        tr.appendChild(tdValue);
                        table.appendChild(tr);
                    }
                    section.appendChild(table);
                } else if (data === null) {
                    section.innerHTML += '<p style="color: #e74c3c;">è®°å½•ä¸å­˜åœ¨</p>';
                } else {
                    section.innerHTML += `<p style="color: #e74c3c;">é”™è¯¯: ${data.error}</p>`;
                }
                
                details.appendChild(section);
            });
            
            // æ˜¾ç¤ºå†²çª
            if (result.has_conflicts) {
                const conflictSection = document.createElement('div');
                conflictSection.style.marginTop = '20px';
                conflictSection.style.padding = '15px';
                conflictSection.style.backgroundColor = '#fff3cd';
                conflictSection.style.borderRadius = '4px';
                
                const conflictTitle = document.createElement('h5');
                conflictTitle.textContent = 'æ£€æµ‹åˆ°å†²çª';
                conflictTitle.style.color = '#856404';
                conflictSection.appendChild(conflictTitle);
                
                // éœ€è¦éšè—çš„æ•æ„Ÿå­—æ®µ
                const hiddenFields = ['password_hash', 'password', 'passwordhash'];
                
                result.conflicts.forEach(conflict => {
                    // è·³è¿‡å¯†ç å­—æ®µçš„å†²çªæ˜¾ç¤º
                    if (conflict.field && hiddenFields.some(field => conflict.field.toLowerCase() === field.toLowerCase())) {
                        return;
                    }
                    
                    const p = document.createElement('p');
                    if (conflict.type === 'data_mismatch') {
                        p.innerHTML = `å­—æ®µ <strong>${conflict.field}</strong> åœ¨ ${conflict.databases.join(' å’Œ ')} ä¸­ä¸ä¸€è‡´`;
                        const values = document.createElement('div');
                        values.style.marginLeft = '20px';
                        values.style.fontSize = '12px';
                        for (const [db, val] of Object.entries(conflict.values)) {
                            values.innerHTML += `${db}: ${val}<br>`;
                        }
                        p.appendChild(values);
                    } else {
                        p.textContent = conflict.message;
                    }
                    conflictSection.appendChild(p);
                });
                
                details.appendChild(conflictSection);
                
                // ä¿å­˜å½“å‰å†²çªä¿¡æ¯
                currentConflict = {
                    table: tableName,
                    record_id: recordId
                };
            }
            
            document.getElementById('conflictResolveModal').style.display = 'block';
        }

        // æŸ¥çœ‹æ‰€æœ‰å†²çª
        async function showConflicts() {
            document.getElementById('dbLoading').style.display = 'block';
            document.getElementById('dbTableContainer').style.display = 'none';
            document.getElementById('conflictContainer').style.display = 'none';
            
            try {
                const response = await apiRequest('/admin/database/find-all-conflicts', {
                    method: 'POST',
                    body: JSON.stringify({
                        table: currentTable || null
                    })
                });
                
                if (response.success) {
                    displayConflictList(response.conflicts);
                } else {
                    showMessage('æŸ¥æ‰¾å†²çªå¤±è´¥: ' + response.error, 'danger');
                }
            } catch (error) {
                showMessage('æŸ¥æ‰¾å†²çªå¤±è´¥: ' + error.message, 'danger');
            } finally {
                document.getElementById('dbLoading').style.display = 'none';
            }
        }

        // æ˜¾ç¤ºå†²çªåˆ—è¡¨
        function displayConflictList(conflicts) {
            const container = document.getElementById('conflictList');
            container.innerHTML = '';
            
            if (conflicts.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #27ae60; padding: 20px;">æœªå‘ç°æ•°æ®å†²çª</p>';
            } else {
                conflicts.forEach((conflict, index) => {
                    const card = document.createElement('div');
                    card.style.border = '1px solid #e74c3c';
                    card.style.borderRadius = '4px';
                    card.style.padding = '15px';
                    card.style.marginBottom = '10px';
                    card.style.backgroundColor = '#fff5f5';
                    
                    card.innerHTML = `
                        <h5>å†²çª #${index + 1}</h5>
                        <p><strong>è¡¨:</strong> ${conflict.table}</p>
                        <p><strong>è®°å½•ID:</strong> ${conflict.record_id}</p>
                        <p><strong>å†²çªæ•°é‡:</strong> ${conflict.conflicts.length}</p>
                        <button class="btn btn-sm btn-primary" onclick="resolveConflictById('${conflict.table}', ${conflict.record_id})">
                            è§£å†³å†²çª
                        </button>
                    `;
                    
                    container.appendChild(card);
                });
            }
            
            document.getElementById('conflictContainer').style.display = 'block';
        }

        // è§£å†³å†²çª
        async function resolveConflictById(table, recordId) {
            currentConflict = { table, record_id: recordId };
            
            // å…ˆè·å–è¯¦ç»†ä¿¡æ¯
            try {
                const response = await apiRequest('/admin/database/compare-records', {
                    method: 'POST',
                    body: JSON.stringify({
                        table: table,
                        record_id: recordId
                    })
                });
                
                if (response.success) {
                    displayComparisonResult(response, table, recordId);
                }
            } catch (error) {
                showMessage('è·å–å†²çªè¯¦æƒ…å¤±è´¥: ' + error.message, 'danger');
            }
        }

        // æ‰§è¡Œå†²çªè§£å†³
        async function executeConflictResolution() {
            if (!currentConflict) {
                showMessage('æ²¡æœ‰é€‰æ‹©è¦è§£å†³çš„å†²çª', 'warning');
                return;
            }
            
            const strategy = document.getElementById('conflictStrategy').value;
            
            // éªŒè¯å‚æ•°
            if (!currentConflict.table || !currentConflict.record_id) {
                showMessage('å†²çªä¿¡æ¯ä¸å®Œæ•´ï¼Œè¯·é‡æ–°é€‰æ‹©è®°å½•', 'warning');
                console.error('å†²çªä¿¡æ¯:', currentConflict);
                return;
            }
            
            console.log('å‘é€å†²çªè§£å†³è¯·æ±‚:', {
                table: currentConflict.table,
                record_id: currentConflict.record_id,
                strategy: strategy
            });
            
            try {
                const response = await apiRequest('/admin/database/resolve-conflict', {
                    method: 'POST',
                    body: JSON.stringify({
                        table: currentConflict.table,
                        record_id: currentConflict.record_id,
                        strategy: strategy
                    })
                });
                
                if (response.success) {
                    showMessage('å†²çªè§£å†³æˆåŠŸ', 'success');
                    closeConflictResolveModal();
                    if (currentTable) {
                        loadTableData(currentPage);
                    }
                } else {
                    showMessage('å†²çªè§£å†³å¤±è´¥: ' + response.error, 'danger');
                }
            } catch (error) {
                showMessage('å†²çªè§£å†³å¤±è´¥: ' + error.message, 'danger');
            }
        }

        // å¯¹æ¯”æ‰€æœ‰æ•°æ®åº“
        async function compareAllDatabases() {
            if (!currentTable) {
                showMessage('è¯·å…ˆé€‰æ‹©è¡¨æ ¼', 'warning');
                return;
            }
            
            showMessage('æ­£åœ¨å¯¹æ¯”ä¸‰ä¸ªæ•°æ®åº“çš„æ•°æ®...', 'info');
            await showConflicts();
        }

        // åˆ é™¤è®°å½•
        let currentDeleteRecord = null;
        
        function deleteRecord(row, primaryKeys) {
            currentDeleteRecord = { row, primaryKeys };
            
            // æ˜¾ç¤ºåˆ é™¤ä¿¡æ¯
            const dbNames = {
                'sqlite': 'SQLite (ä¸»åº“)',
                'mysql': 'MySQL (ä»åº“)',
                'sqlserver': 'SQL Server (ä»åº“)'
            };
            
            document.getElementById('deleteDatabase').textContent = dbNames[currentDatabase];
            document.getElementById('deleteTable').textContent = currentTable;
            
            // æ˜¾ç¤ºè®°å½•è¯¦æƒ…
            const infoDiv = document.getElementById('deleteRecordInfo');
            infoDiv.innerHTML = '';
            
            // æ˜¾ç¤ºä¸»é”®ä¿¡æ¯
            primaryKeys.forEach(pk => {
                const p = document.createElement('p');
                p.style.margin = '5px 0';
                p.innerHTML = `<strong>${pk}:</strong> ${row[pk]}`;
                infoDiv.appendChild(p);
            });
            
            // æ˜¾ç¤ºå…¶ä»–å…³é”®å­—æ®µï¼ˆå¦‚nameç­‰ï¼‰
            const displayFields = ['name', 'username', 'dept_name', 'title_name'];
            displayFields.forEach(field => {
                if (row[field] && !primaryKeys.includes(field)) {
                    const p = document.createElement('p');
                    p.style.margin = '5px 0';
                    p.innerHTML = `<strong>${field}:</strong> ${row[field]}`;
                    infoDiv.appendChild(p);
                }
            });
            
            document.getElementById('deleteConfirmModal').style.display = 'block';
        }
        
        // ç¡®è®¤åˆ é™¤æ•°æ®åº“è®°å½•
        async function confirmDatabaseDelete() {
            if (!currentDeleteRecord) return;
            
            const { row, primaryKeys } = currentDeleteRecord;
            
            // æ„å»ºä¸»é”®å¯¹è±¡
            const primaryKey = {};
            primaryKeys.forEach(col => {
                primaryKey[col] = row[col];
            });
            
            try {
                const response = await apiRequest('/admin/database/delete-record', {
                    method: 'POST',
                    body: JSON.stringify({
                        database: currentDatabase,
                        table: currentTable,
                        primary_key: primaryKey
                    })
                });
                
                if (response.success) {
                    showMessage('è®°å½•åˆ é™¤æˆåŠŸ', 'success');
                    closeDeleteConfirmModal();
                    loadTableData(currentPage);
                } else {
                    showMessage('åˆ é™¤å¤±è´¥: ' + response.error, 'danger');
                }
            } catch (error) {
                showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'danger');
            }
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeEditDataModal() {
            document.getElementById('editDataModal').style.display = 'none';
            currentEditRecord = null;
        }

        function closeConflictResolveModal() {
            document.getElementById('conflictResolveModal').style.display = 'none';
            currentConflict = null;
        }
        
        function closeDeleteConfirmModal() {
            document.getElementById('deleteConfirmModal').style.display = 'none';
            currentDeleteRecord = null;
        }

        // ==================== æ•°æ®åº“åŒæ­¥é…ç½®åŠŸèƒ½ ====================
        let selectedStrategy = 'timestamp_priority';

        // åˆå§‹åŒ–åŒæ­¥é…ç½®
        async function initSyncConfig() {
            try {
                await loadSyncConfig();
                await loadSchedulerStatus();
            } catch (error) {
                console.error('åˆå§‹åŒ–åŒæ­¥é…ç½®å¤±è´¥:', error);
            }
        }

        // æ ¼å¼åŒ–é—´éš”æ—¶é—´æ˜¾ç¤º
        function formatInterval(minutes) {
            console.log('formatInterval è¢«è°ƒç”¨ï¼Œå‚æ•°:', minutes);
            
            if (minutes < 1) {
                // å°äº1åˆ†é’Ÿï¼Œæ˜¾ç¤ºç§’æ•°
                const seconds = Math.round(minutes * 60);
                const result = `${seconds}ç§’`;
                console.log('æ ¼å¼åŒ–ç»“æœ (ç§’):', result);
                return result;
            } else if (minutes < 60) {
                // å°äº60åˆ†é’Ÿï¼Œæ˜¾ç¤ºåˆ†é’Ÿï¼ˆä¿ç•™1ä½å°æ•°ï¼‰
                const result = `${minutes.toFixed(1)}åˆ†é’Ÿ`;
                console.log('æ ¼å¼åŒ–ç»“æœ (åˆ†é’Ÿ):', result);
                return result;
            } else {
                // å¤§äºç­‰äº60åˆ†é’Ÿï¼Œæ˜¾ç¤ºå°æ—¶å’Œåˆ†é’Ÿ
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = Math.round(minutes % 60);
                const result = remainingMinutes === 0 ? `${hours}å°æ—¶` : `${hours}å°æ—¶${remainingMinutes}åˆ†é’Ÿ`;
                console.log('æ ¼å¼åŒ–ç»“æœ (å°æ—¶):', result);
                return result;
            }
        }

        // åŠ è½½åŒæ­¥é…ç½®
        async function loadSyncConfig() {
            try {
                const response = await apiRequest('/admin/sync-config/get');
                if (response.success && response.config) {
                    const config = response.config;
                    document.getElementById('checkIntervalInput').value = config.check_interval_minutes;
                    
                    // æ ¼å¼åŒ–æ˜¾ç¤ºé—´éš”æ—¶é—´
                    const intervalText = formatInterval(config.check_interval_minutes);
                    document.getElementById('currentInterval').textContent = intervalText;
                    
                    selectedStrategy = config.default_strategy;
                    
                    // è®¾ç½®é€‰ä¸­çš„ç­–ç•¥
                    const radio = document.querySelector(`input[name="syncStrategy"][value="${selectedStrategy}"]`);
                    if (radio) {
                        radio.checked = true;
                        
                        // æ›´æ–°è¾¹æ¡†æ ·å¼
                        document.querySelectorAll('.strategy-option').forEach(option => {
                            option.style.border = '2px solid #e0e0e0';
                        });
                        const selectedOption = radio.closest('.strategy-option');
                        if (selectedOption) {
                            selectedOption.style.border = '2px solid #007bff';
                        }
                    }
                }
            } catch (error) {
                console.error('åŠ è½½åŒæ­¥é…ç½®å¤±è´¥:', error);
            }
        }

        // åŠ è½½è°ƒåº¦å™¨çŠ¶æ€
        async function loadSchedulerStatus() {
            try {
                const response = await apiRequest('/admin/sync-config/scheduler/status');
                if (response.success && response.status) {
                    updateSchedulerUI(response.status.running);
                    
                    // æ ¼å¼åŒ–æ˜¾ç¤ºé—´éš”æ—¶é—´
                    const intervalText = formatInterval(response.status.check_interval_minutes);
                    document.getElementById('currentInterval').textContent = intervalText;
                }
            } catch (error) {
                console.error('åŠ è½½è°ƒåº¦å™¨çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // æ›´æ–°è°ƒåº¦å™¨UI
        function updateSchedulerUI(isRunning) {
            console.log('æ›´æ–°è°ƒåº¦å™¨UIï¼Œè¿è¡ŒçŠ¶æ€:', isRunning);
            
            const statusDot = document.getElementById('schedulerStatus');
            const statusText = document.getElementById('schedulerStatusText');
            const toggleBtn = document.getElementById('schedulerToggleBtn');
            const btnIcon = document.getElementById('schedulerBtnIcon');
            const btnText = document.getElementById('schedulerBtnText');

            if (!toggleBtn || !btnIcon || !btnText) {
                console.error('æ‰¾ä¸åˆ°æŒ‰é’®å…ƒç´ ');
                return;
            }

            if (isRunning) {
                // è°ƒåº¦å™¨è¿è¡Œä¸­ - æ˜¾ç¤ºæš‚åœæŒ‰é’®
                statusDot.style.color = '#28a745';
                statusText.textContent = 'è¿è¡Œä¸­';
                
                // å¼ºåˆ¶æ›´æ–°æŒ‰é’®æ ·å¼
                toggleBtn.className = 'btn btn-warning';
                toggleBtn.style.backgroundColor = '#ffc107';
                toggleBtn.style.borderColor = '#ffc107';
                toggleBtn.style.color = '#212529';
                
                btnIcon.textContent = 'â¸';
                btnText.textContent = 'æš‚åœè°ƒåº¦å™¨';
                
                console.log('æŒ‰é’®å·²è®¾ç½®ä¸ºæš‚åœæ¨¡å¼');
            } else {
                // è°ƒåº¦å™¨å·²åœæ­¢ - æ˜¾ç¤ºå¯åŠ¨æŒ‰é’®
                statusDot.style.color = '#dc3545';
                statusText.textContent = 'å·²åœæ­¢';
                
                // å¼ºåˆ¶æ›´æ–°æŒ‰é’®æ ·å¼
                toggleBtn.className = 'btn btn-success';
                toggleBtn.style.backgroundColor = '#28a745';
                toggleBtn.style.borderColor = '#28a745';
                toggleBtn.style.color = '#fff';
                
                btnIcon.textContent = 'â–¶';
                btnText.textContent = 'å¯åŠ¨è°ƒåº¦å™¨';
                
                console.log('æŒ‰é’®å·²è®¾ç½®ä¸ºå¯åŠ¨æ¨¡å¼');
            }
        }

        // é€‰æ‹©åŒæ­¥ç­–ç•¥
        async function selectStrategy(strategy) {
            selectedStrategy = strategy;
            const radio = document.querySelector(`input[name="syncStrategy"][value="${strategy}"]`);
            if (radio) radio.checked = true;
            
            // æ›´æ–°è¾¹æ¡†æ ·å¼
            document.querySelectorAll('.strategy-option').forEach(option => {
                option.style.border = '2px solid #e0e0e0';
            });
            const selectedOption = radio.closest('.strategy-option');
            if (selectedOption) {
                selectedOption.style.border = '2px solid #007bff';
            }
            
            // è‡ªåŠ¨ä¿å­˜é»˜è®¤ç­–ç•¥
            try {
                const response = await apiRequest('/admin/sync-config/update', 'POST', {
                    default_strategy: strategy
                });

                if (response.success) {
                    showMessage(`é»˜è®¤åŒæ­¥ç­–ç•¥å·²è®¾ç½®ä¸ºï¼š${getStrategyName(strategy)}`, 'success');
                } else {
                    showMessage(response.error || 'ä¿å­˜ç­–ç•¥å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('ä¿å­˜é»˜è®¤ç­–ç•¥å¤±è´¥:', error);
                showMessage('ä¿å­˜é»˜è®¤ç­–ç•¥å¤±è´¥', 'error');
            }
        }

        // æ›´æ–°åŒæ­¥é—´éš”
        async function updateSyncInterval() {
            try {
                const interval = parseFloat(document.getElementById('checkIntervalInput').value);
                
                if (isNaN(interval) || interval < 0.17 || interval > 1440) {
                    showMessage('æ£€æŸ¥é—´éš”å¿…é¡»åœ¨0.17-1440åˆ†é’Ÿä¹‹é—´ï¼ˆ10ç§’-24å°æ—¶ï¼‰', 'error');
                    return;
                }

                const response = await apiRequest('/admin/sync-config/update', 'POST', {
                    check_interval_minutes: interval
                });

                if (response.success) {
                    showMessage(response.message || 'åŒæ­¥é—´éš”å·²æ›´æ–°', 'success');
                    
                    // æ ¼å¼åŒ–æ˜¾ç¤ºé—´éš”æ—¶é—´
                    const intervalText = formatInterval(interval);
                    document.getElementById('currentInterval').textContent = intervalText;
                } else {
                    showMessage(response.error || 'æ›´æ–°å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ›´æ–°åŒæ­¥é—´éš”å¤±è´¥:', error);
                showMessage('æ›´æ–°åŒæ­¥é—´éš”å¤±è´¥', 'error');
            }
        }

        // åˆ‡æ¢è°ƒåº¦å™¨çŠ¶æ€
        async function toggleScheduler() {
            try {
                console.log('å¼€å§‹åˆ‡æ¢è°ƒåº¦å™¨çŠ¶æ€');
                
                // å…ˆè·å–å½“å‰çœŸå®çŠ¶æ€
                const statusResponse = await apiRequest('/admin/sync-config/scheduler/status');
                
                if (!statusResponse.success) {
                    showMessage('æ— æ³•è·å–è°ƒåº¦å™¨çŠ¶æ€', 'error');
                    return;
                }
                
                const isCurrentlyRunning = statusResponse.status.running;
                console.log('å½“å‰è°ƒåº¦å™¨çŠ¶æ€:', isCurrentlyRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢');
                
                if (isCurrentlyRunning) {
                    // å½“å‰è¿è¡Œä¸­ï¼Œæ‰§è¡Œåœæ­¢æ“ä½œ
                    console.log('å‡†å¤‡åœæ­¢è°ƒåº¦å™¨');
                    
                    // ç«‹å³æ›´æ–°UIä¸ºåœæ­¢çŠ¶æ€ï¼ˆä¹è§‚æ›´æ–°ï¼‰
                    updateSchedulerUI(false);
                    
                    const response = await apiRequest('/admin/sync-config/scheduler/stop', 'POST');
                    
                    if (response.success) {
                        showMessage('è°ƒåº¦å™¨å·²åœæ­¢', 'success');
                        // ç¡®ä¿UIæ˜¯åœæ­¢çŠ¶æ€
                        updateSchedulerUI(false);
                    } else {
                        // å¯èƒ½å·²ç»åœæ­¢äº†ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯"æœªåœ¨è¿è¡Œ"çš„é”™è¯¯
                        if (response.error && response.error.includes('è°ƒåº¦å™¨æœªåœ¨è¿è¡Œ')) {
                            showMessage('è°ƒåº¦å™¨å·²ç»æ˜¯åœæ­¢çŠ¶æ€', 'info');
                            updateSchedulerUI(false);
                        } else {
                            showMessage(response.error || 'åœæ­¢å¤±è´¥', 'error');
                            // æ¢å¤åˆ°è¿è¡ŒçŠ¶æ€
                            updateSchedulerUI(true);
                            await loadSchedulerStatus();
                        }
                    }
                } else {
                    // å½“å‰å·²åœæ­¢ï¼Œæ‰§è¡Œå¯åŠ¨æ“ä½œ
                    console.log('å‡†å¤‡å¯åŠ¨è°ƒåº¦å™¨');
                    
                    // ç«‹å³æ›´æ–°UIä¸ºè¿è¡ŒçŠ¶æ€ï¼ˆä¹è§‚æ›´æ–°ï¼‰
                    updateSchedulerUI(true);
                    
                    const response = await apiRequest('/admin/sync-config/scheduler/start', 'POST');
                    
                    if (response.success) {
                        showMessage('è°ƒåº¦å™¨å·²å¯åŠ¨', 'success');
                        // ç¡®ä¿UIæ˜¯è¿è¡ŒçŠ¶æ€
                        updateSchedulerUI(true);
                    } else {
                        // å¯èƒ½å·²ç»å¯åŠ¨äº†ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯"å·²åœ¨è¿è¡Œ"çš„é”™è¯¯
                        if (response.error && response.error.includes('è°ƒåº¦å™¨å·²åœ¨è¿è¡Œ')) {
                            showMessage('è°ƒåº¦å™¨å·²ç»åœ¨è¿è¡Œä¸­', 'info');
                            updateSchedulerUI(true);
                        } else {
                            showMessage(response.error || 'å¯åŠ¨å¤±è´¥', 'error');
                            // æ¢å¤åˆ°åœæ­¢çŠ¶æ€
                            updateSchedulerUI(false);
                            await loadSchedulerStatus();
                        }
                    }
                }
            } catch (error) {
                console.error('åˆ‡æ¢è°ƒåº¦å™¨çŠ¶æ€å¤±è´¥:', error);
                showMessage(error.message || 'æ“ä½œå¤±è´¥', 'error');
                // åˆ·æ–°çŠ¶æ€ä»¥ç¡®ä¿UIæ­£ç¡®
                await loadSchedulerStatus();
            }
        }

        // æ‰‹åŠ¨åŒæ­¥
        async function manualSync() {
            if (!confirm('ç¡®å®šè¦ç«‹å³åŒæ­¥æ‰€æœ‰æ•°æ®åº“å—ï¼Ÿ\n\nå°†ä½¿ç”¨é€‰å®šçš„ç­–ç•¥ï¼š' + getStrategyName(selectedStrategy))) {
                return;
            }

            try {
                showMessage('æ­£åœ¨åŒæ­¥ï¼Œè¯·ç¨å€™...', 'info');
                
                const response = await apiRequest('/admin/sync-config/manual-sync', 'POST', {
                    strategy: selectedStrategy
                });

                if (response.success) {
                    showMessage(response.message || 'åŒæ­¥å®Œæˆ', 'success');
                    
                    // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
                    if (response.total_conflicts > 0) {
                        const details = `\nå…±å‘ç° ${response.total_conflicts} ä¸ªå†²çª\næˆåŠŸè§£å†³ ${response.resolved_conflicts} ä¸ª`;
                        alert('åŒæ­¥å®Œæˆï¼' + details);
                    }
                } else {
                    showMessage(response.error || 'åŒæ­¥å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ‰‹åŠ¨åŒæ­¥å¤±è´¥:', error);
                showMessage('æ‰‹åŠ¨åŒæ­¥å¤±è´¥', 'error');
            }
        }

        // è·å–ç­–ç•¥åç§°
        function getStrategyName(strategy) {
            const names = {
                'timestamp_priority': 'æ—¶é—´æˆ³ä¼˜å…ˆ',
                'primary_priority': 'SQLiteä¼˜å…ˆ',
                'mysql_priority': 'MySQLä¼˜å…ˆ',
                'sqlserver_priority': 'SQL Serverä¼˜å…ˆ'
            };
            return names[strategy] || strategy;
        }

        // ç§»åŠ¨ç«¯ä¾§è¾¹æ åˆ‡æ¢
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            if (sidebar.classList.contains('mobile-open')) {
                sidebar.classList.remove('mobile-open');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.add('mobile-open');
                overlay.classList.add('active');
            }
        }
        
        // çª—å£å¤§å°æ”¹å˜æ—¶çš„å¤„ç†
        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            if (window.innerWidth > 768) {
                // æ¡Œé¢ç«¯æ—¶ç§»é™¤ç§»åŠ¨ç«¯ç±»
                sidebar.classList.remove('mobile-open');
                overlay.classList.remove('active');
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–åŒæ­¥é…ç½®
        document.addEventListener('DOMContentLoaded', function() {
            // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿åœ¨æ•°æ®åº“ç®¡ç†éƒ¨åˆ†åˆå§‹åŒ–ä¹‹å
            setTimeout(initSyncConfig, 1000);
            
            // é¢å¤–çš„æ˜¾ç¤ºä¿®å¤ - ç¡®ä¿é—´éš”æ˜¾ç¤ºæ­£ç¡®
            setTimeout(() => {
                const currentInterval = document.getElementById('currentInterval');
                if (currentInterval && currentInterval.textContent.includes('undefined')) {
                    currentInterval.textContent = '10åˆ†é’Ÿ';
                    console.log('å½“å‰æ˜¾ç¤º: 10åˆ†é’Ÿ');
                }
            }, 2000);
        });
    </script>
</body>
</html>
