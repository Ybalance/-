<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‚£è€…ç•Œé¢ - åŒ»é™¢æŒ‚å·ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/booking-style.css">
    <link rel="stylesheet" href="assets/responsive.css">
    <link rel="stylesheet" href="assets/refresh-styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="assets/realtime-sync.js"></script>
    <script src="assets/enhanced-api.js"></script>
    <script src="assets/instant-response.js"></script>
    <script src="assets/on-demand-refresh.js"></script>
</head>
<body>
    <!-- æ¶ˆæ¯æç¤º -->
    <div id="message" class="alert" style="display: none;"></div>

    <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>

    <!-- ä¾§è¾¹æ é®ç½©å±‚ -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="admin-layout">
        <!-- ä¾§è¾¹æ å¯¼èˆª -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>åŒ»é™¢æŒ‚å·ç³»ç»Ÿ</h2>
                <p class="sidebar-subtitle">æ‚£è€…ç«¯</p>
            </div>
            
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" onclick="showSection('booking')">
                    <span class="nav-icon">ğŸ“…</span>
                    <span class="nav-text">é¢„çº¦æŒ‚å·</span>
                </a>
                <a href="#" class="nav-item" onclick="showSection('myRegistrations')">
                    <span class="nav-icon">ğŸ“‹</span>
                    <span class="nav-text">æˆ‘çš„æŒ‚å·</span>
                </a>
                <a href="#" class="nav-item" onclick="showSection('profile')">
                    <span class="nav-icon">âš™ï¸</span>
                    <span class="nav-text">ä¸ªäººä¿¡æ¯</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <span class="user-icon">ğŸ‘¤</span>
                    <div class="user-details">
                        <div class="user-name" id="username"></div>
                        <div class="user-role">æ‚£è€…</div>
                    </div>
                </div>
                
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </aside>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">

            <!-- é¢„çº¦æŒ‚å· -->
            <div id="section-booking" class="content-section active">
                <div class="card">
                    <h2>é¢„çº¦æŒ‚å·</h2>
                    
                    <!-- é€‰æ‹©ç§‘å®¤ -->
                    <div class="form-group">
                        <label>é€‰æ‹©ç§‘å®¤</label>
                        <select id="deptSelect" class="form-control" onchange="onDeptSelect()">
                            <option value="">è¯·é€‰æ‹©ç§‘å®¤</option>
                        </select>
                    </div>
                    
                    <!-- é€‰æ‹©æ—¥æœŸå’Œæ—¶æ®µçš„è¡¨æ ¼ -->
                    <div id="scheduleTableContainer" style="display: none;">
                        <h3 style="margin: 1.5rem 0 1rem 0; color: #333;">é€‰æ‹©å°±è¯Šæ—¶é—´</h3>
                        <div class="schedule-table-container">
                            <table class="schedule-table booking-schedule-table">
                                <thead>
                                    <tr>
                                        <th style="width: 100px;">æ—¶æ®µ</th>
                                        <th id="date0"></th>
                                        <th id="date1"></th>
                                        <th id="date2"></th>
                                        <th id="date3"></th>
                                        <th id="date4"></th>
                                        <th id="date5"></th>
                                        <th id="date6"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>ä¸Šåˆ</strong><br><small>00:00-12:00</small></td>
                                        <td id="slot_0_am" class="time-slot" onclick="selectSlot(0, 'am')"></td>
                                        <td id="slot_1_am" class="time-slot" onclick="selectSlot(1, 'am')"></td>
                                        <td id="slot_2_am" class="time-slot" onclick="selectSlot(2, 'am')"></td>
                                        <td id="slot_3_am" class="time-slot" onclick="selectSlot(3, 'am')"></td>
                                        <td id="slot_4_am" class="time-slot" onclick="selectSlot(4, 'am')"></td>
                                        <td id="slot_5_am" class="time-slot" onclick="selectSlot(5, 'am')"></td>
                                        <td id="slot_6_am" class="time-slot" onclick="selectSlot(6, 'am')"></td>
                                    </tr>
                                    <tr>
                                        <td><strong>ä¸‹åˆ</strong><br><small>12:00-24:00</small></td>
                                        <td id="slot_0_pm" class="time-slot" onclick="selectSlot(0, 'pm')"></td>
                                        <td id="slot_1_pm" class="time-slot" onclick="selectSlot(1, 'pm')"></td>
                                        <td id="slot_2_pm" class="time-slot" onclick="selectSlot(2, 'pm')"></td>
                                        <td id="slot_3_pm" class="time-slot" onclick="selectSlot(3, 'pm')"></td>
                                        <td id="slot_4_pm" class="time-slot" onclick="selectSlot(4, 'pm')"></td>
                                        <td id="slot_5_pm" class="time-slot" onclick="selectSlot(5, 'pm')"></td>
                                        <td id="slot_6_pm" class="time-slot" onclick="selectSlot(6, 'pm')"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem; color: #666;">
                            <strong>è¯´æ˜ï¼š</strong>ç‚¹å‡»è¡¨æ ¼ä¸­çš„åŒ»ç”Ÿæ•°é‡å³å¯é€‰æ‹©è¯¥æ—¶æ®µè¿›è¡Œé¢„çº¦
                        </div>
                    </div>
                    
                    <!-- é€‰æ‹©åŒ»ç”Ÿ -->
                    <div id="doctorSelectContainer" style="display: none; margin-top: 2rem;">
                        <h3 style="margin-bottom: 1rem; color: #333;">é€‰æ‹©åŒ»ç”Ÿ</h3>
                        <div id="doctorCards" class="selection-cards">
                            <!-- åŒ»ç”Ÿå¡ç‰‡å°†åŠ¨æ€åŠ è½½ -->
                        </div>
                        
                        <!-- é€‰æ‹©å…·ä½“æ—¶é—´ -->
                        <div id="timeSelectContainer" style="display: none; margin-top: 1.5rem;">
                            <h3 style="margin-bottom: 1rem; color: #333;">é€‰æ‹©å…·ä½“æ—¶é—´</h3>
                            <div class="form-group">
                                <select id="specificTimeSelect" class="form-control" onchange="onSpecificTimeSelect()">
                                    <option value="">è¯·é€‰æ‹©å…·ä½“æ—¶é—´</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- é¢„çº¦ä¿¡æ¯ç¡®è®¤ -->
                        <div id="confirmInfo" style="display: none; margin-top: 1.5rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
                            <h4 style="margin-bottom: 1rem;">é¢„çº¦ä¿¡æ¯</h4>
                            <table class="table" style="margin-bottom: 1rem;">
                                <tr>
                                    <td style="width: 100px; font-weight: 500;">ç§‘å®¤</td>
                                    <td id="confirmDept">-</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 500;">æ—¥æœŸ</td>
                                    <td id="confirmDate">-</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 500;">æ—¶æ®µ</td>
                                    <td id="confirmTime">-</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 500;">åŒ»ç”Ÿ</td>
                                    <td id="confirmDoctor">-</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: 500;">æŒ‚å·è´¹</td>
                                    <td id="confirmFee" style="color: #667eea; font-weight: 600; font-size: 1.1rem;">Â¥0.00</td>
                                </tr>
                            </table>
                            <div style="text-align: right;">
                                <button class="btn btn-secondary" onclick="resetBooking()">é‡æ–°é€‰æ‹©</button>
                                <button class="btn btn-primary" onclick="confirmBooking()">ç¡®è®¤é¢„çº¦</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æˆ‘çš„æŒ‚å·è®°å½• -->
            <div id="section-myRegistrations" class="content-section">
                <!-- æœç´¢åŠŸèƒ½ -->
                <div class="card">
                    <h2>æœç´¢æŒ‚å·è®°å½•</h2>
                    <div class="grid grid-3">
                        <div class="form-group">
                            <label for="searchRegId">æŒ‚å·ID</label>
                            <input type="text" id="searchRegId" class="form-control" placeholder="è¾“å…¥æŒ‚å·ID">
                        </div>
                        <div class="form-group">
                            <label for="searchDoctor">åŒ»ç”Ÿå§“å</label>
                            <input type="text" id="searchDoctor" class="form-control" placeholder="è¾“å…¥åŒ»ç”Ÿå§“å">
                        </div>
                        <div class="form-group">
                            <label for="searchDept">ç§‘å®¤</label>
                            <input type="text" id="searchDept" class="form-control" placeholder="è¾“å…¥ç§‘å®¤åç§°">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="searchRegistrations()">æœç´¢</button>
                    <button class="btn btn-secondary" onclick="clearSearch()">æ¸…ç©º</button>
                </div>

                <!-- æŒ‚å·è®°å½•åˆ—è¡¨ -->
                <div class="card">
                    <h2>æˆ‘çš„æŒ‚å·è®°å½•</h2>
                    <div class="loading" id="registrationsLoading">
                        <div class="spinner"></div>
                    </div>
                    <div id="registrationsContainer" style="display: none;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>æŒ‚å·ID</th>
                                    <th>åŒ»ç”Ÿ</th>
                                    <th>èŒç§°</th>
                                    <th>ç§‘å®¤</th>
                                    <th>ç§‘å®¤ä½ç½®</th>
                                    <th>é¢„çº¦æ—¶é—´</th>
                                    <th>æŒ‚å·è´¹</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="registrationsTable">
                            </tbody>
                        </table>
                        <div id="noRegistrations" style="display: none; text-align: center; padding: 2rem; color: #666;">
                            æš‚æ— æŒ‚å·è®°å½•
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸ªäººä¿¡æ¯ -->
            <div id="section-profile" class="content-section">
                <div class="card" style="max-width: 800px; margin: 0 auto;">
                    <h2>ä¸ªäººä¿¡æ¯</h2>
                    
                    <!-- ç´¯è®¡æŒ‚å·è´¹æ˜¾ç¤º -->
                    <div style="background: #f0f9ff; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #3b82f6;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.95rem; color: #64748b;">ç´¯è®¡æŒ‚å·è´¹ç”¨</span>
                            <span style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;" id="totalFeeDisplay">Â¥0.00</span>
                        </div>
                    </div>
                    
                    <form id="profileForm" onsubmit="updateProfile(event)">
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label for="profileName">å§“å *</label>
                                <input type="text" id="profileName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="profilePhone">æ‰‹æœºå·ç </label>
                                <input type="tel" id="profilePhone" class="form-control" pattern="[0-9]{11}" title="è¯·è¾“å…¥11ä½æ‰‹æœºå·ç ">
                            </div>
                        </div>
                        
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label for="profilePassword">æ–°å¯†ç ï¼ˆç•™ç©ºåˆ™ä¸ä¿®æ”¹ï¼‰</label>
                                <input type="password" id="profilePassword" class="form-control" placeholder="å¦‚éœ€ä¿®æ”¹å¯†ç è¯·è¾“å…¥æ–°å¯†ç ">
                            </div>
                            <div class="form-group">
                                <label for="profilePasswordConfirm">ç¡®è®¤æ–°å¯†ç </label>
                                <input type="password" id="profilePasswordConfirm" class="form-control" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">ä¿å­˜ä¿®æ”¹</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- å–æ¶ˆæŒ‚å·ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="cancelModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¡®è®¤å–æ¶ˆæŒ‚å·</h3>
                <span class="close" onclick="closeCancelModal()">&times;</span>
            </div>
            <p>ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªæŒ‚å·å—ï¼Ÿå–æ¶ˆåæ— æ³•æ¢å¤ã€‚</p>
            <div style="text-align: right; margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="closeCancelModal()">å–æ¶ˆ</button>
                <button class="btn btn-danger" onclick="confirmCancel()">ç¡®è®¤å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script src="assets/config.js"></script>
    <script>
        let currentCancelId = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            if (!localStorage.getItem('token') || localStorage.getItem('role') !== 'patient') {
                window.location.href = 'login.html';
                return;
            }

            // Set username
            document.getElementById('username').textContent = localStorage.getItem('username');

            // Load initial data
            loadDepartments();
        });

        function showSection(sectionName) {
            console.log('Switching to section:', sectionName);
            
            // éšè—æ‰€æœ‰å†…å®¹åŒºåŸŸ
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰å¯¼èˆªé¡¹çš„activeç±»
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„å†…å®¹åŒºåŸŸ
            const targetSection = document.getElementById(`section-${sectionName}`);
            console.log('Target section:', targetSection);
            if (targetSection) {
                targetSection.classList.add('active');
                console.log('Section activated');
            } else {
                console.error('Section not found:', `section-${sectionName}`);
            }
            
            // é«˜äº®é€‰ä¸­çš„å¯¼èˆªé¡¹
            if (window.event && window.event.target) {
                const navItem = window.event.target.closest('.nav-item');
                if (navItem) {
                    navItem.classList.add('active');
                }
            } else {
                // å¦‚æœæ²¡æœ‰eventï¼Œæ‰‹åŠ¨æŸ¥æ‰¾å¹¶é«˜äº®å¯¹åº”çš„å¯¼èˆªé¡¹
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    if (item.getAttribute('onclick')?.includes(sectionName)) {
                        item.classList.add('active');
                    }
                });
            }
            
            // åŠ è½½å¯¹åº”æ•°æ®
            if (sectionName === 'myRegistrations') {
                loadRegistrations();
            } else if (sectionName === 'profile') {
                loadProfile();
            } else if (sectionName === 'booking') {
                // é‡ç½®é¢„çº¦è¡¨å•
                resetBooking();
            }
        }

        // Booking state
        let bookingState = {
            department: null,
            dateIndex: null,
            date: null,
            timeSlot: null,
            doctor: null,
            specificTime: null
        };

        let datesList = [];

        async function loadDepartments() {
            try {
                const departments = await apiRequest('/departments');
                const select = document.getElementById('deptSelect');
                select.innerHTML = '<option value="">è¯·é€‰æ‹©ç§‘å®¤</option>';
                
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.dept_id;
                    option.textContent = `${dept.dept_name} - ${dept.location}`;
                    option.dataset.deptName = dept.dept_name;
                    select.appendChild(option);
                });
            } catch (error) {
                showMessage('åŠ è½½ç§‘å®¤ä¿¡æ¯å¤±è´¥: ' + error.message, 'danger');
            }
        }

        async function onDeptSelect() {
            const select = document.getElementById('deptSelect');
            const deptId = select.value;
            
            if (!deptId) {
                document.getElementById('scheduleTableContainer').style.display = 'none';
                document.getElementById('doctorSelectContainer').style.display = 'none';
                return;
            }
            
            bookingState.department = {
                dept_id: deptId,
                dept_name: select.options[select.selectedIndex].dataset.deptName
            };
            
            // æ˜¾ç¤ºæ—¶é—´è¡¨æ ¼
            document.getElementById('scheduleTableContainer').style.display = 'block';
            document.getElementById('doctorSelectContainer').style.display = 'none';
            
            // ç”Ÿæˆæ—¥æœŸè¡¨å¤´å’Œæ—¶é—´æ§½
            await loadScheduleTable();
        }

        async function loadScheduleTable() {
            const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            const today = new Date();
            datesList = [];
            
            // ç”Ÿæˆæ—¥æœŸè¡¨å¤´
            for (let i = 0; i < 7; i++) {
                const date = new Date(today.getTime() + i * 24 * 60 * 60 * 1000);
                datesList.push(date);
                
                const th = document.getElementById(`date${i}`);
                th.innerHTML = `
                    <div>${weekdays[date.getDay()]}</div>
                    <div style="font-size: 1.2rem; font-weight: bold; margin: 0.25rem 0;">${date.getDate()}</div>
                    <div style="font-size: 0.85rem; color: #999;">${date.getMonth() + 1}æœˆ</div>
                `;
            }
            
            // åŠ è½½æ¯ä¸ªæ—¶é—´æ§½çš„åŒ»ç”Ÿæ•°é‡
            for (let i = 0; i < 7; i++) {
                const date = datesList[i];
                const weekday = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][date.getDay()];
                
                try {
                    const doctors = await apiRequest(`/doctors?dept_id=${bookingState.department.dept_id}`);
                    
                    let amCount = 0;
                    let pmCount = 0;
                    
                    doctors.forEach(doctor => {
                        if (doctor.schedule) {
                            try {
                                const schedule = JSON.parse(doctor.schedule);
                                if (schedule[`${weekday}_am`]) amCount++;
                                if (schedule[`${weekday}_pm`]) pmCount++;
                            } catch (e) {
                                amCount++;
                                pmCount++;
                            }
                        } else {
                            amCount++;
                            pmCount++;
                        }
                    });
                    
                    const amCell = document.getElementById(`slot_${i}_am`);
                    const pmCell = document.getElementById(`slot_${i}_pm`);
                    
                    if (amCount > 0) {
                        amCell.innerHTML = `${amCount}ä½åŒ»ç”Ÿ`;
                        amCell.classList.remove('disabled');
                    } else {
                        amCell.innerHTML = 'æ— ';
                        amCell.classList.add('disabled');
                    }
                    
                    if (pmCount > 0) {
                        pmCell.innerHTML = `${pmCount}ä½åŒ»ç”Ÿ`;
                        pmCell.classList.remove('disabled');
                    } else {
                        pmCell.innerHTML = 'æ— ';
                        pmCell.classList.add('disabled');
                    }
                } catch (error) {
                    console.error('åŠ è½½æ—¶æ®µä¿¡æ¯å¤±è´¥:', error);
                }
            }
        }

        async function selectSlot(dateIndex, timeSlot) {
            const cell = document.getElementById(`slot_${dateIndex}_${timeSlot}`);
            if (cell.classList.contains('disabled')) {
                return;
            }
            
            bookingState.dateIndex = dateIndex;
            // ä½¿ç”¨æœ¬åœ°æ—¥æœŸæ ¼å¼ï¼Œé¿å…æ—¶åŒºè½¬æ¢é—®é¢˜
            const date = datesList[dateIndex];
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            bookingState.date = `${year}-${month}-${day}`;
            bookingState.timeSlot = timeSlot;
            
            // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.time-slot').forEach(td => {
                td.classList.remove('selected');
            });
            cell.classList.add('selected');
            
            // éšè—ç¡®è®¤ä¿¡æ¯
            document.getElementById('confirmInfo').style.display = 'none';
            
            // æ˜¾ç¤ºåŒ»ç”Ÿé€‰æ‹©
            document.getElementById('doctorSelectContainer').style.display = 'block';
            await loadDoctors();
        }

        async function loadDoctors() {
            try {
                const doctors = await apiRequest(
                    `/doctors?dept_id=${bookingState.department.dept_id}&date=${bookingState.date}&time=${bookingState.timeSlot}`
                );
                
                const container = document.getElementById('doctorCards');
                container.innerHTML = '';
                
                // éšè—ç¡®è®¤ä¿¡æ¯
                document.getElementById('confirmInfo').style.display = 'none';
                
                if (doctors.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">è¯¥æ—¶æ®µæš‚æ— å¯ç”¨åŒ»ç”Ÿ</p>';
                    return;
                }
                
                // åˆ›å»ºå ä½å›¾SVG
                const placeholderSvg = `data:image/svg+xml,%3Csvg width='120' height='160' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='120' height='160' fill='%23f8f9fa'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='14' fill='%23999' text-anchor='middle' dy='.3em'%3EåŒ»ç”Ÿç…§ç‰‡%3C/text%3E%3C/svg%3E`;
                
                doctors.forEach(doctor => {
                    const fee = doctor.registration_fee || 15;
                    const photoUrl = doctor.photo ? `${API_BASE_URL.replace('/api', '')}/uploads/${doctor.photo}` : placeholderSvg;
                    
                    const card = document.createElement('div');
                    card.className = 'doctor-card';
                    card.onclick = () => selectDoctor(doctor);
                    card.innerHTML = `
                        <img src="${photoUrl}" alt="${doctor.name}" class="doctor-avatar" onerror="this.src='${placeholderSvg}'">
                        <div class="doctor-name">${doctor.name}</div>
                        <div class="doctor-title">${doctor.title || 'åŒ»å¸ˆ'}</div>
                        <div class="doctor-fee">æŒ‚å·è´¹ï¼šÂ¥${fee.toFixed(2)}</div>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                showMessage('åŠ è½½åŒ»ç”Ÿä¿¡æ¯å¤±è´¥: ' + error.message, 'danger');
            }
        }

        function selectDoctor(doctor) {
            bookingState.doctor = doctor;
            
            // æ›´æ–°UI
            document.querySelectorAll('.doctor-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.doctor-card').classList.add('selected');
            
            // æ˜¾ç¤ºå…·ä½“æ—¶é—´é€‰æ‹©
            loadSpecificTimes();
            document.getElementById('timeSelectContainer').style.display = 'block';
            document.getElementById('confirmInfo').style.display = 'none';
        }

        function loadSpecificTimes() {
            const select = document.getElementById('specificTimeSelect');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©å…·ä½“æ—¶é—´</option>';
            
            // è·å–å½“å‰ä¸­å›½æ—¶é—´
            const now = new Date();
            const selectedDate = datesList[bookingState.dateIndex];
            const isToday = selectedDate.toDateString() === now.toDateString();
            
            // æ ¹æ®ä¸Šåˆ/ä¸‹åˆç¡®å®šæ—¶é—´èŒƒå›´
            let startHour, endHour;
            if (bookingState.timeSlot === 'am') {
                // ä¸Šåˆï¼š00:00 - 11:30
                startHour = 0;
                endHour = 11;
            } else {
                // ä¸‹åˆï¼š12:00 - 23:30
                startHour = 12;
                endHour = 23;
            }
            
            // ç”Ÿæˆæ—¶é—´é€‰é¡¹
            for (let hour = startHour; hour <= endHour; hour++) {
                for (let minute of [0, 30]) {
                    // å¦‚æœæ˜¯ä»Šå¤©ï¼Œéœ€è¦æ£€æŸ¥æ—¶é—´æ˜¯å¦å·²è¿‡
                    if (isToday) {
                        const timeToCheck = new Date(selectedDate);
                        timeToCheck.setHours(hour, minute, 0, 0);
                        
                        // å¦‚æœæ—¶é—´å·²è¿‡ï¼Œè·³è¿‡
                        if (timeToCheck <= now) {
                            continue;
                        }
                    }
                    
                    const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                    const option = document.createElement('option');
                    option.value = timeStr;
                    option.textContent = timeStr;
                    select.appendChild(option);
                }
            }
            
            // å¦‚æœæ²¡æœ‰å¯é€‰æ—¶é—´ï¼Œæ˜¾ç¤ºæç¤º
            if (select.options.length === 1) {
                select.innerHTML = '<option value="">è¯¥æ—¶æ®µå·²è¿‡ï¼Œæ— å¯é€‰æ—¶é—´</option>';
            }
        }

        function onSpecificTimeSelect() {
            const timeSelect = document.getElementById('specificTimeSelect');
            const selectedTime = timeSelect.value;
            
            if (!selectedTime) {
                document.getElementById('confirmInfo').style.display = 'none';
                return;
            }
            
            bookingState.specificTime = selectedTime;
            
            // æ˜¾ç¤ºç¡®è®¤ä¿¡æ¯
            showConfirmInfo();
        }

        function showConfirmInfo() {
            const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            const dateObj = datesList[bookingState.dateIndex];
            const dateDisplay = `${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥ ${weekdays[dateObj.getDay()]}`;
            const timeDisplay = bookingState.specificTime || (bookingState.timeSlot === 'am' ? 'ä¸Šåˆ' : 'ä¸‹åˆ');
            
            document.getElementById('confirmDept').textContent = bookingState.department.dept_name;
            document.getElementById('confirmDate').textContent = dateDisplay;
            document.getElementById('confirmTime').textContent = timeDisplay;
            document.getElementById('confirmDoctor').textContent = `${bookingState.doctor.name} (${bookingState.doctor.title})`;
            document.getElementById('confirmFee').textContent = `Â¥${bookingState.doctor.registration_fee.toFixed(2)}`;
            
            document.getElementById('confirmInfo').style.display = 'block';
        }

        function resetBooking() {
            bookingState = {
                department: null,
                dateIndex: null,
                date: null,
                timeSlot: null,
                doctor: null,
                specificTime: null
            };
            
            document.getElementById('deptSelect').value = '';
            document.getElementById('scheduleTableContainer').style.display = 'none';
            document.getElementById('doctorSelectContainer').style.display = 'none';
            document.getElementById('timeSelectContainer').style.display = 'none';
            document.querySelectorAll('.time-slot').forEach(td => {
                td.classList.remove('selected');
            });
        }

        async function confirmBooking() {
            try {
                // ç”Ÿæˆé¢„çº¦æ—¶é—´ - ä½¿ç”¨å…·ä½“é€‰æ‹©çš„æ—¶é—´
                const specificTime = bookingState.specificTime || (bookingState.timeSlot === 'am' ? '09:00' : '15:00');
                const regTime = `${bookingState.date} ${specificTime}:00`;
                
                await apiRequest('/registrations', {
                    method: 'POST',
                    body: JSON.stringify({
                        doctor_id: bookingState.doctor.doctor_id,
                        reg_time: regTime
                    })
                });
                
                showMessage('é¢„çº¦æˆåŠŸï¼', 'success');
                resetBooking();
                
                // åˆ‡æ¢åˆ°æŒ‚å·è®°å½•é¡µé¢
                setTimeout(() => {
                    showSection('myRegistrations');
                }, 1500);
            } catch (error) {
                showMessage('é¢„çº¦å¤±è´¥: ' + error.message, 'danger');
            }
        }

        let allRegistrations = [];
        let filteredRegistrations = [];

        async function loadRegistrations() {
            const loading = document.getElementById('registrationsLoading');
            const container = document.getElementById('registrationsContainer');
            
            loading.style.display = 'flex';
            container.style.display = 'none';

            try {
                allRegistrations = await apiRequest('/patient/registrations');
                filteredRegistrations = [...allRegistrations];
                displayRegistrations(filteredRegistrations);
                container.style.display = 'block';
            } catch (error) {
                showMessage('åŠ è½½æŒ‚å·è®°å½•å¤±è´¥: ' + error.message, 'danger');
            } finally {
                loading.style.display = 'none';
            }
        }

        function displayRegistrations(registrations) {
            const tbody = document.getElementById('registrationsTable');
            const noRegistrations = document.getElementById('noRegistrations');
            
            tbody.innerHTML = '';
            
            if (registrations.length === 0) {
                noRegistrations.style.display = 'block';
            } else {
                noRegistrations.style.display = 'none';
                
                registrations.forEach(reg => {
                    const row = document.createElement('tr');
                    const regTime = new Date(reg.reg_time);
                    const canCancel = reg.status === 'registered' && regTime > new Date(Date.now() + 60 * 60 * 1000);
                    
                    row.innerHTML = `
                        <td>${reg.reg_id}</td>
                        <td>${reg.doctor_name}</td>
                        <td>${reg.doctor_title || '-'}</td>
                        <td>${reg.dept_name}</td>
                        <td>${reg.dept_location || '-'}</td>
                        <td>${formatDateTime(reg.reg_time)}</td>
                        <td>Â¥${(reg.fee || 0).toFixed(2)}</td>
                        <td><span class="status-badge status-${reg.status}">${getStatusText(reg.status)}</span></td>
                        <td>
                            ${canCancel ? 
                                `<button class="btn btn-danger btn-sm" onclick="showCancelModal(${reg.reg_id})">å–æ¶ˆæŒ‚å·</button>` : 
                                '<span style="color: #999;">ä¸å¯å–æ¶ˆ</span>'
                            }
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        function searchRegistrations() {
            const regId = document.getElementById('searchRegId').value.trim();
            const doctor = document.getElementById('searchDoctor').value.trim().toLowerCase();
            const dept = document.getElementById('searchDept').value.trim().toLowerCase();

            filteredRegistrations = allRegistrations.filter(reg => {
                const matchRegId = !regId || reg.reg_id.toString().includes(regId);
                const matchDoctor = !doctor || reg.doctor_name.toLowerCase().includes(doctor);
                const matchDept = !dept || reg.dept_name.toLowerCase().includes(dept);
                return matchRegId && matchDoctor && matchDept;
            });

            displayRegistrations(filteredRegistrations);
        }

        function clearSearch() {
            document.getElementById('searchRegId').value = '';
            document.getElementById('searchDoctor').value = '';
            document.getElementById('searchDept').value = '';
            filteredRegistrations = [...allRegistrations];
            displayRegistrations(filteredRegistrations);
        }

        function showCancelModal(regId) {
            currentCancelId = regId;
            document.getElementById('cancelModal').style.display = 'block';
        }

        function closeCancelModal() {
            document.getElementById('cancelModal').style.display = 'none';
            currentCancelId = null;
        }

        async function confirmCancel() {
            if (!currentCancelId) return;

            try {
                await apiRequest(`/registrations/${currentCancelId}/cancel`, {
                    method: 'POST'
                });

                showMessage('æŒ‚å·å·²å–æ¶ˆ', 'success');
                closeCancelModal();
                loadRegistrations();
            } catch (error) {
                showMessage('å–æ¶ˆæŒ‚å·å¤±è´¥: ' + error.message, 'danger');
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'registered': 'å·²æŒ‚å·',
                'completed': 'å·²å°±è¯Š',
                'cancelled': 'å·²è¿‡å·'
            };
            return statusMap[status] || status;
        }

        function formatDateTime(dateTimeStr) {
            const date = new Date(dateTimeStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `alert alert-${type} message`;
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        // ç§»åŠ¨ç«¯èœå•æ§åˆ¶
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        // ç‚¹å‡»å¯¼èˆªé¡¹åè‡ªåŠ¨å…³é—­ç§»åŠ¨ç«¯èœå•
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    toggleSidebar();
                }
            });
        });

        async function loadProfile() {
            try {
                const profile = await apiRequest('/patient/profile');
                document.getElementById('profileName').value = profile.name || '';
                document.getElementById('profilePhone').value = profile.phone || '';
                document.getElementById('profilePassword').value = '';
                document.getElementById('profilePasswordConfirm').value = '';
                
                // æ˜¾ç¤ºç´¯è®¡æŒ‚å·è´¹
                const totalFee = profile.total_fee || 0;
                document.getElementById('totalFeeDisplay').textContent = `Â¥${totalFee.toFixed(2)}`;
            } catch (error) {
                showMessage('åŠ è½½ä¸ªäººä¿¡æ¯å¤±è´¥', 'danger');
            }
        }

        async function updateProfile(event) {
            event.preventDefault();
            
            const password = document.getElementById('profilePassword').value;
            const passwordConfirm = document.getElementById('profilePasswordConfirm').value;
            const phone = document.getElementById('profilePhone').value;
            
            if (password && password !== passwordConfirm) {
                showMessage('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'warning');
                return;
            }
            
            if (phone && !/^[0-9]{11}$/.test(phone)) {
                showMessage('æ‰‹æœºå·ç å¿…é¡»æ˜¯11ä½æ•°å­—', 'warning');
                return;
            }
            
            try {
                const data = {
                    name: document.getElementById('profileName').value,
                    phone: phone
                };
                
                if (password) {
                    data.password = password;
                }
                
                await apiRequest('/patient/profile', {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                
                showMessage('ä¸ªäººä¿¡æ¯æ›´æ–°æˆåŠŸ', 'success');
                
                // æ›´æ–°ä¾§è¾¹æ æ˜¾ç¤ºçš„ç”¨æˆ·å
                document.getElementById('username').textContent = data.name;
                localStorage.setItem('username', data.name);
                
                // æ¸…ç©ºå¯†ç å­—æ®µ
                document.getElementById('profilePassword').value = '';
                document.getElementById('profilePasswordConfirm').value = '';
            } catch (error) {
                showMessage('æ›´æ–°å¤±è´¥: ' + error.message, 'danger');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('role');
            localStorage.removeItem('username');
            localStorage.removeItem('user_id');
            window.location.href = 'login.html';
        }

        // æ‰‹åŠ¨åˆ·æ–°å‡½æ•°å·²ç§»é™¤

        // åˆ·æ–°æŒ‡å®šsectionçš„æ•°æ®
        async function refreshSectionData(sectionName) {
            try {
                switch (sectionName) {
                    case 'myRegistrations':
                        await loadRegistrations();
                        break;
                    case 'booking':
                        await loadDepartments();
                        // å¦‚æœæœ‰é€‰ä¸­çš„ç§‘å®¤ï¼Œä¹Ÿåˆ·æ–°åŒ»ç”Ÿåˆ—è¡¨
                        const deptSelect = document.getElementById('deptSelect');
                        if (deptSelect && deptSelect.value) {
                            await onDeptSelect();
                        }
                        break;
                    case 'profile':
                        await loadProfile();
                        break;
                }
                
                // æ˜¾ç¤ºåˆ·æ–°æˆåŠŸæç¤º
                showMessage('æ•°æ®å·²åˆ·æ–°', 'success');
            } catch (error) {
                showMessage('åˆ·æ–°å¤±è´¥: ' + error.message, 'danger');
            }
        }

        // æ›´æ–°é¡µé¢æ ‡é¢˜
        function updatePageTitle(sectionName) {
            const titles = {
                'booking': 'é¢„çº¦æŒ‚å·',
                'myRegistrations': 'æˆ‘çš„æŒ‚å·',
                'profile': 'ä¸ªäººä¿¡æ¯'
            };
            
            const titleElement = document.getElementById('pageTitle');
            if (titleElement && titles[sectionName]) {
                titleElement.textContent = titles[sectionName];
            }
        }

        // æ‰©å±•showSectionå‡½æ•°ä»¥æ”¯æŒæ ‡é¢˜æ›´æ–°
        const originalShowSection = window.showSection;
        window.showSection = function(sectionName) {
            if (originalShowSection) {
                originalShowSection(sectionName);
            }
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            updatePageTitle(sectionName);
        };

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('cancelModal');
            if (event.target === modal) {
                closeCancelModal();
            }
        }
    </script>
</body>
</html>
